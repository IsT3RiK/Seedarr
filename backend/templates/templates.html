{% extends "base.html" %}

{% block title %}Templates - Seedarr{% endblock %}

{% block page_title %}Templates{% endblock %}

{% block content %}
<div class="templates-page">
    <!-- Tab Navigation -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" data-tab="presentation" onclick="switchTab('presentation')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                </svg>
                Presentation (BBCode)
            </button>
            <button class="tab" data-tab="naming" onclick="switchTab('naming')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Nommage
            </button>
            <button class="tab" data-tab="nfo" onclick="switchTab('nfo')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                NFO
            </button>
        </div>
    </div>

    <!-- Tab Content: Presentation (BBCode) -->
    <div id="tab-presentation" class="tab-content active">
        <div class="templates-container">
            <!-- Left Panel: Templates List -->
            <div class="templates-sidebar">
                <div class="sidebar-header">
                    <h2>Templates BBCode</h2>
                    <div class="header-actions">
                        <button class="btn btn-sm" onclick="openImportModal('bbcode')" title="Importer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                        </button>
                        <button class="btn btn-sm" onclick="exportAllTemplates('bbcode')" title="Exporter tout">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="createNewBBCodeTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nouveau
                        </button>
                    </div>
                </div>
                <div class="templates-list" id="bbcode-templates-list">
                    {% for template in bbcode_templates %}
                    <div class="template-item {% if loop.first %}active{% endif %}"
                         data-id="{{ template.id }}"
                         onclick="loadBBCodeTemplate({{ template.id }})">
                        <div class="template-item-header">
                            <span class="template-name">{{ template.name }}</span>
                            {% if template.is_default %}
                            <span class="badge-default">Defaut</span>
                            {% endif %}
                        </div>
                        <div class="template-item-meta">
                            {{ template.updated_at.strftime('%d/%m/%Y %H:%M') if template.updated_at else '' }}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-list">
                        <p>Aucun template</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Content: Editor -->
            <div class="editor-main">
                <div class="editor-header">
                    <div class="editor-title-row">
                        <input type="text" id="bbcode-template-name" class="input-title" placeholder="Nom du template">
                        <input type="hidden" id="bbcode-template-id">
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="setBBCodeAsDefault()" id="btn-bbcode-default" title="Definir par defaut">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-danger" onclick="deleteBBCodeTemplate()" id="btn-bbcode-delete" title="Supprimer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary" onclick="saveBBCodeTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Sauvegarder
                        </button>
                    </div>
                </div>

                <div class="editor-description">
                    <input type="text" id="bbcode-template-description" class="input-description" placeholder="Description du template (optionnel)">
                </div>

                <!-- Variables Panel -->
                <div class="variables-panel">
                    <details class="variables-accordion" open>
                        <summary class="accordion-header">
                            <span class="accordion-title">Variables disponibles</span>
                        </summary>
                        <div class="variables-chips">
                            {% for category, vars in bbcode_variables.items() %}
                            {% for key, desc in vars.items() %}
                            <button class="var-chip" onclick="insertBBCodeVariable('{{ key }}')" title="{{ desc }}">{{ key }}</button>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </details>
                </div>

                <!-- BBCode Editor with Preview -->
                <div class="editor-preview-container">
                    <div class="editor-pane">
                        <div class="pane-header">
                            <span class="pane-title">Code BBCode</span>
                        </div>
                        <textarea id="bbcode-template-content" class="code-editor" placeholder="Entrez votre template BBCode ici..."></textarea>
                    </div>
                    <div class="preview-pane">
                        <div class="pane-header">
                            <span class="pane-title">Apercu</span>
                            <span class="preview-badge">Live</span>
                        </div>
                        <div id="bbcode-preview" class="bbcode-preview-content">
                            <p class="preview-placeholder">L'apercu s'affichera ici...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Naming -->
    <div id="tab-naming" class="tab-content">
        <div class="templates-container">
            <!-- Left Panel: Templates List -->
            <div class="templates-sidebar">
                <div class="sidebar-header">
                    <h2>Templates Nommage</h2>
                    <div class="header-actions">
                        <button class="btn btn-sm" onclick="openImportModal('naming')" title="Importer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                        </button>
                        <button class="btn btn-sm" onclick="exportAllTemplates('naming')" title="Exporter tout">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="createNewNamingTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nouveau
                        </button>
                    </div>
                </div>
                <div class="templates-list" id="naming-templates-list">
                    {% for template in naming_templates %}
                    <div class="template-item {% if loop.first %}active{% endif %}"
                         data-id="{{ template.id }}"
                         onclick="loadNamingTemplate({{ template.id }})">
                        <div class="template-item-header">
                            <span class="template-name">{{ template.name }}</span>
                            {% if template.is_default %}
                            <span class="badge-default">Defaut</span>
                            {% endif %}
                        </div>
                        <div class="template-item-meta">
                            {{ template.updated_at.strftime('%d/%m/%Y %H:%M') if template.updated_at else '' }}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-list">
                        <p>Aucun template de nommage</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Example Templates -->
                <div class="examples-section">
                    <h3>Exemples</h3>
                    {% for example in naming_examples %}
                    <div class="example-item" onclick="useNamingExample('{{ example.template }}')">
                        <span class="example-name">{{ example.name }}</span>
                        <code class="example-template">{{ example.template }}</code>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Content: Editor -->
            <div class="editor-main">
                <div class="editor-header">
                    <div class="editor-title-row">
                        <input type="text" id="naming-template-name" class="input-title" placeholder="Nom du template">
                        <input type="hidden" id="naming-template-id">
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="setNamingAsDefault()" id="btn-naming-default" title="Definir par defaut">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-danger" onclick="deleteNamingTemplate()" id="btn-naming-delete" title="Supprimer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary" onclick="saveNamingTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Sauvegarder
                        </button>
                    </div>
                </div>

                <div class="editor-description">
                    <input type="text" id="naming-template-description" class="input-description" placeholder="Description du template (optionnel)">
                </div>

                <!-- Variables Panel -->
                <div class="variables-panel">
                    <details class="variables-accordion" open>
                        <summary class="accordion-header">
                            <span class="accordion-title">Variables disponibles</span>
                        </summary>
                        <div class="variables-chips">
                            {% for category, vars in naming_variables.items() %}
                            {% for key, desc in vars.items() %}
                            <button class="var-chip var-chip-naming" onclick="insertNamingVariable('{{ key }}')" title="{{ desc }}">{{"{"}}{{ key }}{{"}"}}</button>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </details>
                </div>

                <!-- Naming Template Editor -->
                <div class="naming-editor-area">
                    <label class="editor-label">Format du nom de release</label>
                    <input type="text" id="naming-template-content" class="naming-input"
                           placeholder="{titre}.{annee}.{langue}.{resolution}.{source}.{codec_video}-{group}">

                    <!-- Live Preview -->
                    <div class="naming-preview">
                        <label class="preview-label">Apercu</label>
                        <div id="naming-preview-result" class="preview-result">
                            Cloud.9.2014.MULTi.1080p.WEB.H264-FW
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: NFO -->
    <div id="tab-nfo" class="tab-content">
        <div class="templates-container">
            <!-- Left Panel: Templates List -->
            <div class="templates-sidebar">
                <div class="sidebar-header">
                    <h2>Templates NFO</h2>
                    <div class="header-actions">
                        <button class="btn btn-sm" onclick="openImportModal('nfo')" title="Importer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                        </button>
                        <button class="btn btn-sm" onclick="exportAllTemplates('nfo')" title="Exporter tout">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="createNewNFOTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nouveau
                        </button>
                    </div>
                </div>
                <div class="templates-list" id="nfo-templates-list">
                    {% for template in nfo_templates %}
                    <div class="template-item {% if loop.first %}active{% endif %}"
                         data-id="{{ template.id }}"
                         onclick="loadNFOTemplate({{ template.id }})">
                        <div class="template-item-header">
                            <span class="template-name">{{ template.name }}</span>
                            {% if template.is_default %}
                            <span class="badge-default">Defaut</span>
                            {% endif %}
                        </div>
                        <div class="template-item-meta">
                            {{ template.updated_at.strftime('%d/%m/%Y %H:%M') if template.updated_at else '' }}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-list">
                        <p>Aucun template NFO</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Content: Editor -->
            <div class="editor-main">
                <div class="editor-header">
                    <div class="editor-title-row">
                        <input type="text" id="nfo-template-name" class="input-title" placeholder="Nom du template">
                        <input type="hidden" id="nfo-template-id">
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="setNFOAsDefault()" id="btn-nfo-default" title="Definir par defaut">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-danger" onclick="deleteNFOTemplate()" id="btn-nfo-delete" title="Supprimer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        <button class="btn btn-primary" onclick="saveNFOTemplate()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Sauvegarder
                        </button>
                    </div>
                </div>

                <div class="editor-description">
                    <input type="text" id="nfo-template-description" class="input-description" placeholder="Description du template (optionnel)">
                </div>

                <!-- Variables Panel -->
                <div class="variables-panel">
                    <details class="variables-accordion" open>
                        <summary class="accordion-header">
                            <span class="accordion-title">Variables disponibles</span>
                        </summary>
                        <div class="variables-chips">
                            {% for category, vars in nfo_variables.items() %}
                            {% for key, desc in vars.items() %}
                            <button class="var-chip var-chip-nfo" onclick="insertNFOVariable('{{ key }}')" title="{{ desc }}">{{ "{{" }}{{ key }}{{ "}}" }}</button>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </details>
                </div>

                <!-- NFO Editor -->
                <div class="editor-area">
                    <textarea id="nfo-template-content" class="code-editor nfo-editor" placeholder="Entrez votre template NFO ici..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="import-modal-overlay">
    <div class="import-modal-backdrop" onclick="closeImportModal()"></div>
    <div class="import-modal-content">
        <div class="import-modal-header">
            <h3 id="import-modal-title">Importer des templates</h3>
            <button class="import-modal-close" onclick="closeImportModal()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="import-modal-body">
            <input type="hidden" id="import-type">

            <div class="drop-zone" id="drop-zone">
                <svg class="drop-zone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="drop-zone-text">Glissez un fichier JSON ici</p>
                <p class="drop-zone-subtext">ou</p>
                <label class="btn btn-secondary drop-zone-btn">
                    <span>Parcourir</span>
                    <input type="file" accept=".json" id="import-file" onchange="handleFileSelect(event)" hidden>
                </label>
            </div>

            <div id="import-file-info" class="import-file-info" style="display: none;">
                <div class="file-info-header">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span id="import-file-name"></span>
                    <button class="btn-icon" onclick="clearImportFile()" title="Supprimer">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="import-preview" class="import-preview"></div>
            </div>

            <div class="conflict-options">
                <label class="conflict-label">En cas de conflit de nom :</label>
                <select id="conflict-mode" class="conflict-select">
                    <option value="rename">Renommer (ajouter suffix)</option>
                    <option value="skip">Ignorer</option>
                    <option value="overwrite">Ecraser l'existant</option>
                </select>
            </div>
        </div>
        <div class="import-modal-footer">
            <button class="btn btn-secondary" onclick="closeImportModal()">Annuler</button>
            <button class="btn btn-primary" onclick="confirmImport()" id="btn-confirm-import" disabled>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Importer
            </button>
        </div>
    </div>
</div>

<style>
/* Templates Page Styles */
.templates-page {
    padding: 1rem;
    max-width: 100%;
    min-height: calc(100vh - 120px);
}

/* Tabs */
.tabs-container {
    margin-bottom: 1.5rem;
}

.tabs {
    display: flex;
    gap: 0.75rem;
}

.tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.75rem 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 0.5rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    min-width: 140px;
}

.tab:hover:not(.active) {
    color: var(--text-primary);
    border-color: var(--accent-primary);
}

.tab.active {
    color: var(--accent-primary);
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 1px var(--accent-primary);
}

.tab svg {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}

/* Tab Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Templates Container */
.templates-container {
    display: flex;
    gap: 1rem;
    min-height: calc(100vh - 200px);
}

/* Sidebar */
.templates-sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 200px);
    overflow: hidden;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    gap: 0.5rem;
}

.sidebar-header h2 {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
}

.header-actions {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.templates-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.template-item {
    padding: 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.25rem;
    border: 1px solid transparent;
}

.template-item:hover {
    background: var(--bg-tertiary);
}

.template-item.active {
    background: rgba(234, 179, 8, 0.1);
    border-color: var(--accent-color);
}

.template-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

.template-name {
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.badge-default {
    background: var(--accent-color);
    color: #0f172a;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    flex-shrink: 0;
}

.template-item-meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.empty-list {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-muted);
}

/* Examples Section (Naming) */
.examples-section {
    border-top: 1px solid var(--border-color);
    padding: 0.75rem;
}

.examples-section h3 {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.example-item {
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    margin-bottom: 0.25rem;
    transition: all 0.2s;
}

.example-item:hover {
    background: var(--bg-tertiary);
}

.example-name {
    display: block;
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.example-template {
    display: block;
    font-size: 0.7rem;
    color: var(--accent-color);
    background: rgba(234, 179, 8, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    word-break: break-all;
}

/* Editor Main */
.editor-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    min-width: 0;
}

.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 1rem;
}

.editor-title-row {
    flex: 1;
}

.input-title {
    width: 100%;
    background: transparent;
    border: none;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    padding: 0.25rem 0;
}

.input-title:focus {
    outline: none;
    color: var(--accent-color);
}

.editor-actions {
    display: flex;
    gap: 0.5rem;
}

.editor-description {
    padding: 0 1rem 0.5rem 1rem;
}

.input-description {
    width: 100%;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(100, 116, 139, 0.4);
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.input-description:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* Variables Panel */
.variables-panel {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.variables-accordion {
    border: 1px solid rgba(100, 116, 139, 0.2);
    border-radius: 0.5rem;
    background: rgba(15, 23, 42, 0.3);
}

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    cursor: pointer;
    list-style: none;
}

.accordion-header::-webkit-details-marker {
    display: none;
}

.accordion-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--accent-color);
    text-transform: uppercase;
}

.variables-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    padding: 0.75rem 1rem 1rem;
}

button.var-chip {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08)) !important;
    border: 1.5px solid rgba(96, 165, 250, 0.4) !important;
    border-radius: 0.4rem !important;
    padding: 0.4rem 0.7rem !important;
    font-size: 0.75rem !important;
    font-family: 'Consolas', monospace !important;
    color: #60a5fa !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
    font-weight: 600 !important;
    box-shadow: none !important;
    outline: none !important;
}

button.var-chip:hover {
    border-color: #3b82f6 !important;
    color: #93c5fd !important;
    transform: translateY(-2px);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15)) !important;
}

button.var-chip-naming {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08)) !important;
    border: 1.5px solid rgba(74, 222, 128, 0.4) !important;
    color: #4ade80 !important;
}

button.var-chip-naming:hover {
    border-color: #22c55e !important;
    color: #86efac !important;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.15)) !important;
}

button.var-chip-nfo {
    background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(147, 51, 234, 0.08)) !important;
    border: 1.5px solid rgba(168, 85, 247, 0.4) !important;
    color: #a78bfa !important;
}

button.var-chip-nfo:hover {
    border-color: #9333ea !important;
    color: #c4b5fd !important;
    background: linear-gradient(135deg, rgba(147, 51, 234, 0.25), rgba(147, 51, 234, 0.15)) !important;
}

/* Editor Area */
.editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 400px;
}

/* Editor with Preview Container */
.editor-preview-container {
    flex: 1;
    display: flex;
    gap: 1px;
    background: var(--border-color, #334155);
    min-height: 400px;
}

.editor-pane,
.preview-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary, #1e293b);
    min-width: 0;
}

.pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.5);
    border-bottom: 1px solid var(--border-color, #334155);
}

.pane-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-muted, #64748b);
}

.preview-badge {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
    animation: pulse-badge 2s ease-in-out infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.editor-pane .code-editor {
    flex: 1;
    border-radius: 0;
}

.bbcode-preview-content {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #0f172a;
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-secondary, #94a3b8);
}

.preview-placeholder {
    color: var(--text-muted, #64748b);
    font-style: italic;
}

/* BBCode Preview Styles */
.bbcode-preview-content .bb-bold { font-weight: bold; }
.bbcode-preview-content .bb-italic { font-style: italic; }
.bbcode-preview-content .bb-underline { text-decoration: underline; }
.bbcode-preview-content .bb-strike { text-decoration: line-through; }
.bbcode-preview-content .bb-center { text-align: center; display: block; }
.bbcode-preview-content .bb-left { text-align: left; display: block; }
.bbcode-preview-content .bb-right { text-align: right; display: block; }
.bbcode-preview-content .bb-quote {
    border-left: 3px solid var(--accent-color, #eab308);
    padding: 0.5rem 1rem;
    margin: 0.5rem 0;
    background: rgba(234, 179, 8, 0.1);
    font-style: italic;
}
.bbcode-preview-content .bb-code {
    font-family: 'Consolas', monospace;
    background: rgba(0, 0, 0, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    display: block;
    white-space: pre-wrap;
    margin: 0.5rem 0;
}
.bbcode-preview-content .bb-spoiler {
    background: #333;
    color: #333;
    padding: 0.125rem 0.25rem;
    border-radius: 0.125rem;
    cursor: pointer;
}
.bbcode-preview-content .bb-spoiler:hover {
    color: #fff;
}
.bbcode-preview-content .bb-color { }
.bbcode-preview-content .bb-size { }
.bbcode-preview-content .bb-url {
    color: #60a5fa;
    text-decoration: underline;
}
.bbcode-preview-content .bb-img {
    max-width: 100%;
    height: auto;
    border-radius: 0.25rem;
}

/* Poster images (w500) - larger, centered */
.bbcode-preview-content .bb-img[src*="w500"],
.bbcode-preview-content .bb-img[src*="original"] {
    max-width: 300px;
    display: block;
    margin: 0.5rem auto;
}

/* Cast/profile images (w185) - smaller for cast grid */
.bbcode-preview-content .bb-img[src*="w185"] {
    width: 80px;
    height: 120px;
    object-fit: cover;
    display: block;
    margin: 0 auto 0.25rem auto;
    border-radius: 0.375rem;
}

/* Cast card container */
.bb-cast-card {
    display: inline-block;
    width: 100px;
    text-align: center;
    vertical-align: top;
    margin: 0.5rem;
    font-size: 0.8rem;
}

.bb-cast-card img {
    width: 80px;
    height: 120px;
    object-fit: cover;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
}

.bb-cast-card .cast-name {
    color: var(--accent-color, #eab308);
    font-weight: 500;
}
.bbcode-preview-content .bb-list {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}
.bbcode-preview-content .bb-hr {
    border: none;
    border-top: 1px solid var(--border-color, #334155);
    margin: 1rem 0;
}
.bbcode-preview-content .bb-var {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'Consolas', monospace;
    font-size: 0.85em;
}

.bbcode-preview-content .bb-var-unknown {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}

/* Headings */
.bbcode-preview-content .bb-h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary, #fff);
    margin: 1rem 0 0.5rem 0;
    line-height: 1.3;
}
.bbcode-preview-content .bb-h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text-primary, #fff);
    margin: 0.875rem 0 0.4rem 0;
    line-height: 1.3;
}
.bbcode-preview-content .bb-h3 {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--text-primary, #fff);
    margin: 0.75rem 0 0.3rem 0;
    line-height: 1.3;
}
.bbcode-preview-content .bb-h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary, #94a3b8);
    margin: 0.5rem 0 0.25rem 0;
    line-height: 1.3;
}

/* Inline block for cast cards grid */
.bbcode-preview-content .bb-inline {
    display: inline-block;
    vertical-align: top;
    text-align: center;
    width: 120px;
    margin: 0.5rem;
    font-size: 0.85rem;
}

.bbcode-preview-content .bb-inline .bb-img {
    width: 100px;
    height: 150px;
    object-fit: cover;
    display: block;
    margin: 0 auto 0.25rem auto;
}

.code-editor {
    flex: 1;
    width: 100%;
    background: #0f172a;
    border: none;
    padding: 1rem;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--text-secondary);
    resize: none;
    min-height: 400px;
}

.code-editor:focus {
    outline: none;
}

.nfo-editor {
    font-size: 0.75rem;
    line-height: 1.4;
}

/* Naming Editor */
.naming-editor-area {
    padding: 1.5rem;
    flex: 1;
}

.editor-label,
.preview-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.naming-input {
    width: 100%;
    background: #0f172a;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    font-family: 'Consolas', monospace;
    font-size: 1rem;
    color: var(--accent-color);
}

.naming-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

.naming-preview {
    margin-top: 1.5rem;
}

.preview-result {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    font-family: 'Consolas', monospace;
    font-size: 0.9rem;
    color: #4ade80;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.btn:hover {
    border-color: var(--accent-color);
    color: var(--text-primary);
}

.btn-sm {
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
}

.btn-primary {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: #0f172a;
    font-weight: 600;
}

.btn-primary:hover {
    background: #d4a107;
}

.btn-secondary {
    background: rgba(51, 65, 85, 0.6);
    border-color: rgba(100, 116, 139, 0.4);
}

.btn-secondary:hover {
    background: rgba(251, 191, 36, 0.15);
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.btn-danger:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: #ef4444;
    color: #fca5a5;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

.toast.success {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
    color: #86efac;
}

.toast.error {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
    color: #fca5a5;
}

@keyframes slideIn {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 900px) {
    .templates-container {
        flex-direction: column;
    }
    .templates-sidebar {
        width: 100%;
        min-width: 100%;
        max-height: 250px;
    }
    .editor-preview-container {
        flex-direction: column;
    }
    .editor-pane,
    .preview-pane {
        min-height: 250px;
    }
}

/* Import Modal Styles */
.import-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.import-modal-overlay.active {
    display: flex !important;
}

.import-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9998;
}

.import-modal-content {
    position: relative;
    z-index: 10000;
    background: var(--bg-secondary, #1e293b);
    border: 1px solid var(--border-color, #334155);
    border-radius: 0.75rem;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.import-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color, #334155);
}

.import-modal-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary, #fff);
}

.import-modal-close {
    background: transparent;
    border: none;
    color: var(--text-muted, #64748b);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.15s;
}

.import-modal-close:hover {
    color: var(--text-primary, #fff);
    background: var(--bg-tertiary, #334155);
}

.import-modal-body {
    padding: 1.25rem;
    overflow-y: auto;
}

.import-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border-color, #334155);
}

/* Drop Zone */
.drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
}

.drop-zone:hover,
.drop-zone.drag-over {
    border-color: var(--accent-color);
    background: rgba(234, 179, 8, 0.05);
}

.drop-zone-icon {
    width: 3rem;
    height: 3rem;
    color: var(--text-muted);
    margin: 0 auto 0.75rem;
}

.drop-zone-text {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.drop-zone-subtext {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}

.drop-zone-btn {
    cursor: pointer;
}

/* Import File Info */
.import-file-info {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
}

.file-info-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
}

.file-info-header span {
    flex: 1;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-icon {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.15s;
}

.btn-icon:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

/* Import Preview */
.import-preview {
    font-size: 0.85rem;
}

.import-preview-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
}

.import-preview-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.import-preview-item .preview-icon {
    width: 1rem;
    height: 1rem;
    color: var(--accent-color);
}

.import-preview-item .preview-name {
    flex: 1;
    color: var(--text-secondary);
}

.import-preview-item .preview-desc {
    color: var(--text-muted);
    font-size: 0.75rem;
}

/* Conflict Options */
.conflict-options {
    margin-top: 1rem;
}

.conflict-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.conflict-select {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    padding: 0.625rem 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    cursor: pointer;
}

.conflict-select:focus {
    outline: none;
    border-color: var(--accent-color);
}
</style>

<script>
{% raw %}
// ============================================================================
// Tab Management
// ============================================================================

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
    });
}

// ============================================================================
// Sample Data for Previews
// ============================================================================

const namingSampleData = {
    titre: "Cloud.9",
    titre_fr: "Cloud.9.L.Ultime.Figure",
    titre_en: "Cloud.9",
    titre_lower: "cloud.9",
    titre_fr_lower: "cloud.9.l.ultime.figure",
    titre_en_lower: "cloud.9",
    annee: "2014",
    langue: "MULTi",
    vff: "VFF",
    resolution: "1080p",
    source: "WEB",
    quality: "HDLight",
    codec_audio: "AAC",
    codec_audio_full: "AAC.2.0",
    audio_channels: "2.0",
    codec_video: "x264",
    group: "FW",
    hdr: "",
    saison: "S01",
    episode: "E05"
};

// ============================================================================
// BBCode Templates Functions
// ============================================================================

async function loadBBCodeTemplate(id) {
    try {
        const response = await fetch(`/api/templates/bbcode/${id}`);
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            const t = result.template;
            document.getElementById('bbcode-template-id').value = t.id;
            document.getElementById('bbcode-template-name').value = t.name;
            document.getElementById('bbcode-template-description').value = t.description || '';
            document.getElementById('bbcode-template-content').value = t.content || '';

            // Update active state
            document.querySelectorAll('#bbcode-templates-list .template-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.id) === id);
            });

            // Update buttons
            document.getElementById('btn-bbcode-default').style.display = t.is_default ? 'none' : 'flex';
            document.getElementById('btn-bbcode-delete').style.display = t.is_default ? 'none' : 'flex';

            // Update preview
            updateBBCodePreview();
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function createNewBBCodeTemplate() {
    document.getElementById('bbcode-template-id').value = '';
    document.getElementById('bbcode-template-name').value = '';
    document.getElementById('bbcode-template-description').value = '';
    document.getElementById('bbcode-template-content').value = '';

    document.querySelectorAll('#bbcode-templates-list .template-item').forEach(el => {
        el.classList.remove('active');
    });

    document.getElementById('btn-bbcode-default').style.display = 'none';
    document.getElementById('btn-bbcode-delete').style.display = 'none';
    document.getElementById('bbcode-template-name').focus();

    updateBBCodePreview();
}

async function saveBBCodeTemplate() {
    const id = document.getElementById('bbcode-template-id').value;
    const name = document.getElementById('bbcode-template-name').value.trim();
    const description = document.getElementById('bbcode-template-description').value.trim();
    const content = document.getElementById('bbcode-template-content').value;

    if (!name) {
        showToast('Le nom du template est requis', 'error');
        return;
    }

    const url = id ? `/api/templates/bbcode/${id}` : '/api/templates/bbcode';
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description: description || null, content })
        });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast(id ? 'Template mis a jour' : 'Template cree', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function deleteBBCodeTemplate() {
    const id = document.getElementById('bbcode-template-id').value;
    if (!id) return;

    if (!confirm('Supprimer ce template ?')) return;

    try {
        const response = await fetch(`/api/templates/bbcode/${id}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template supprime', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function setBBCodeAsDefault() {
    const id = document.getElementById('bbcode-template-id').value;
    if (!id) return;

    try {
        const response = await fetch(`/api/templates/bbcode/${id}/set-default`, { method: 'POST' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template defini par defaut', 'success');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function insertBBCodeVariable(varName) {
    const editor = document.getElementById('bbcode-template-content');
    const start = editor.selectionStart;
    const text = editor.value;
    const varText = '{{' + varName + '}}';

    editor.value = text.substring(0, start) + varText + text.substring(start);
    editor.focus();
    editor.setSelectionRange(start + varText.length, start + varText.length);
    updateBBCodePreview();
}

// BBCode Preview Sample Data (matches actual template variables)
// Default fallback data
const defaultSampleData = {
    // MediaInfo (not from TMDB)
    'quality': '1080p BluRay',
    'format': 'MKV',
    'video_codec': 'H.264/AVC',
    'video_bitrate': '12.5 Mb/s',
    'hdr': '',
    'resolution': '1920x1080',
    'duration': '2h 21min 47s',
    'audio_list': 'French DTS-HD MA 5.1, English DTS-HD MA 5.1',
    'audio_table': '[table][tr][td]French[/td][td]DTS-HD MA[/td][td]5.1[/td][/tr][tr][td]English[/td][td]DTS-HD MA[/td][td]5.1[/td][/tr][/table]',
    'languages': 'MULTi (VFF, VO)',
    'subtitles': 'Francais, English',
    'subtitles_table': '[table][tr][td]Francais[/td][td]SRT[/td][/tr][tr][td]English[/td][td]SRT[/td][/tr][/table]',
    'file_size': '8.2 Go',
    'file_count': '1',
    'source': 'BluRay',
    'release_name': 'Harry.Potter.and.the.Prisoner.of.Azkaban.2004.MULTi.1080p.BluRay.x264-FW',
    'release_team': 'FW',
};

// Try to load TMDB data from localStorage (set by Settings > Test TMDB API)
let bbcodeSampleData = { ...defaultSampleData };
try {
    const storedData = localStorage.getItem('tmdb_preview_data');
    if (storedData) {
        const tmdbData = JSON.parse(storedData);
        bbcodeSampleData = { ...defaultSampleData, ...tmdbData };
        console.log('Loaded TMDB preview data:', tmdbData.title);
    } else {
        console.log('No TMDB preview data found. Go to Settings and click "Test" on TMDB API to load sample data.');
    }
} catch (e) {
    console.warn('Could not load TMDB preview data:', e);
}

function updateBBCodePreview() {
    const content = document.getElementById('bbcode-template-content').value;
    const preview = document.getElementById('bbcode-preview');

    if (!content.trim()) {
        preview.innerHTML = '<p class="preview-placeholder">L\'apercu s\'affichera ici...</p>';
        return;
    }

    // Step 1: Replace variables with their actual values
    let processed = content;
    for (const [key, value] of Object.entries(bbcodeSampleData)) {
        const regex = new RegExp('\\{\\{' + key + '\\}\\}', 'gi');
        processed = processed.replace(regex, value || '');
    }

    // Step 2: Mark remaining unknown variables with a placeholder
    processed = processed.replace(/\{\{(\w+)\}\}/g, '[[UNKNOWN:$1]]');

    // Step 3: Parse BBCode to HTML
    let html = parseBBCode(processed);

    // Step 4: Convert unknown variable placeholders to highlighted spans
    html = html.replace(/\[\[UNKNOWN:(\w+)\]\]/g, '<span class="bb-var bb-var-unknown" title="Variable inconnue: $1">&#123;&#123;$1&#125;&#125;</span>');

    preview.innerHTML = html;
}

function parseBBCode(text) {
    // Escape HTML first
    text = escapeHtml(text);

    // Headings
    text = text.replace(/\[h1\]([\s\S]*?)\[\/h1\]/gi, '<h1 class="bb-h1">$1</h1>');
    text = text.replace(/\[h2\]([\s\S]*?)\[\/h2\]/gi, '<h2 class="bb-h2">$1</h2>');
    text = text.replace(/\[h3\]([\s\S]*?)\[\/h3\]/gi, '<h3 class="bb-h3">$1</h3>');
    text = text.replace(/\[h4\]([\s\S]*?)\[\/h4\]/gi, '<h4 class="bb-h4">$1</h4>');

    // Basic formatting
    text = text.replace(/\[b\]([\s\S]*?)\[\/b\]/gi, '<span class="bb-bold">$1</span>');
    text = text.replace(/\[i\]([\s\S]*?)\[\/i\]/gi, '<span class="bb-italic">$1</span>');
    text = text.replace(/\[u\]([\s\S]*?)\[\/u\]/gi, '<span class="bb-underline">$1</span>');
    text = text.replace(/\[s\]([\s\S]*?)\[\/s\]/gi, '<span class="bb-strike">$1</span>');

    // Alignment
    text = text.replace(/\[center\]([\s\S]*?)\[\/center\]/gi, '<div class="bb-center">$1</div>');
    text = text.replace(/\[left\]([\s\S]*?)\[\/left\]/gi, '<div class="bb-left">$1</div>');
    text = text.replace(/\[right\]([\s\S]*?)\[\/right\]/gi, '<div class="bb-right">$1</div>');

    // Inline block (for cast cards, etc.)
    text = text.replace(/\[inline\]([\s\S]*?)\[\/inline\]/gi, '<div class="bb-inline">$1</div>');

    // Color and size
    text = text.replace(/\[color=([^\]]+)\]([\s\S]*?)\[\/color\]/gi, '<span style="color:$1">$2</span>');
    text = text.replace(/\[size=([^\]]+)\]([\s\S]*?)\[\/size\]/gi, '<span style="font-size:$1">$2</span>');

    // Quote and code
    text = text.replace(/\[quote\]([\s\S]*?)\[\/quote\]/gi, '<div class="bb-quote">$1</div>');
    text = text.replace(/\[quote=([^\]]+)\]([\s\S]*?)\[\/quote\]/gi, '<div class="bb-quote"><strong>$1:</strong><br>$2</div>');
    text = text.replace(/\[code\]([\s\S]*?)\[\/code\]/gi, '<pre class="bb-code">$1</pre>');

    // Spoiler
    text = text.replace(/\[spoiler\]([\s\S]*?)\[\/spoiler\]/gi, '<span class="bb-spoiler">$1</span>');

    // URLs
    text = text.replace(/\[url\]([\s\S]*?)\[\/url\]/gi, '<a href="$1" class="bb-url" target="_blank">$1</a>');
    text = text.replace(/\[url=([^\]]+)\]([\s\S]*?)\[\/url\]/gi, '<a href="$1" class="bb-url" target="_blank">$2</a>');

    // Images
    text = text.replace(/\[img\]([\s\S]*?)\[\/img\]/gi, '<img src="$1" class="bb-img" alt="Image">');
    text = text.replace(/\[img=([^\]]+)\]/gi, '<img src="$1" class="bb-img" alt="Image">');

    // Lists
    text = text.replace(/\[list\]([\s\S]*?)\[\/list\]/gi, function(match, content) {
        const items = content.replace(/\[\*\]/g, '</li><li>').replace(/^<\/li>/, '');
        return '<ul class="bb-list">' + items + '</li></ul>';
    });

    // Horizontal rule
    text = text.replace(/\[hr\]/gi, '<hr class="bb-hr">');

    // Line breaks
    text = text.replace(/\n/g, '<br>');

    return text;
}

// ============================================================================
// Naming Templates Functions
// ============================================================================

async function loadNamingTemplate(id) {
    try {
        const response = await fetch(`/api/templates/naming/${id}`);
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            const t = result.template;
            document.getElementById('naming-template-id').value = t.id;
            document.getElementById('naming-template-name').value = t.name;
            document.getElementById('naming-template-description').value = t.description || '';
            document.getElementById('naming-template-content').value = t.template || '';

            document.querySelectorAll('#naming-templates-list .template-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.id) === id);
            });

            document.getElementById('btn-naming-default').style.display = t.is_default ? 'none' : 'flex';
            document.getElementById('btn-naming-delete').style.display = t.is_default ? 'none' : 'flex';

            updateNamingPreview();
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function createNewNamingTemplate() {
    document.getElementById('naming-template-id').value = '';
    document.getElementById('naming-template-name').value = '';
    document.getElementById('naming-template-description').value = '';
    document.getElementById('naming-template-content').value = '';

    document.querySelectorAll('#naming-templates-list .template-item').forEach(el => {
        el.classList.remove('active');
    });

    document.getElementById('btn-naming-default').style.display = 'none';
    document.getElementById('btn-naming-delete').style.display = 'none';
    document.getElementById('naming-template-name').focus();

    updateNamingPreview();
}

async function saveNamingTemplate() {
    const id = document.getElementById('naming-template-id').value;
    const name = document.getElementById('naming-template-name').value.trim();
    const description = document.getElementById('naming-template-description').value.trim();
    const template = document.getElementById('naming-template-content').value;

    if (!name) {
        showToast('Le nom du template est requis', 'error');
        return;
    }

    const url = id ? `/api/templates/naming/${id}` : '/api/templates/naming';
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description: description || null, template })
        });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast(id ? 'Template mis a jour' : 'Template cree', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function deleteNamingTemplate() {
    const id = document.getElementById('naming-template-id').value;
    if (!id) return;

    if (!confirm('Supprimer ce template ?')) return;

    try {
        const response = await fetch(`/api/templates/naming/${id}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template supprime', 'success');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function setNamingAsDefault() {
    const id = document.getElementById('naming-template-id').value;
    if (!id) return;

    try {
        const response = await fetch(`/api/templates/naming/${id}/set-default`, { method: 'POST' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template defini par defaut', 'success');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function insertNamingVariable(varName) {
    const editor = document.getElementById('naming-template-content');
    const start = editor.selectionStart;
    const text = editor.value;
    const varText = '{' + varName + '}';

    editor.value = text.substring(0, start) + varText + text.substring(start);
    editor.focus();
    editor.setSelectionRange(start + varText.length, start + varText.length);

    updateNamingPreview();
}

function useNamingExample(template) {
    document.getElementById('naming-template-content').value = template;
    updateNamingPreview();
}

function updateNamingPreview() {
    const template = document.getElementById('naming-template-content').value;
    let result = template;

    // Replace variables with sample data
    for (const [key, value] of Object.entries(namingSampleData)) {
        const regex = new RegExp('\\{' + key + '\\}', 'g');
        result = result.replace(regex, value);
    }

    // Clean up (remove empty parts)
    result = result.replace(/\.{2,}/g, '.');
    result = result.replace(/\.-/g, '-');
    result = result.replace(/^\.|\.$/, '');

    document.getElementById('naming-preview-result').textContent = result || 'Apercu...';
}

// ============================================================================
// NFO Templates Functions
// ============================================================================

async function loadNFOTemplate(id) {
    try {
        const response = await fetch(`/api/templates/nfo/${id}`);
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            const t = result.template;
            document.getElementById('nfo-template-id').value = t.id;
            document.getElementById('nfo-template-name').value = t.name;
            document.getElementById('nfo-template-description').value = t.description || '';
            document.getElementById('nfo-template-content').value = t.content || '';

            document.querySelectorAll('#nfo-templates-list .template-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.id) === id);
            });

            document.getElementById('btn-nfo-default').style.display = t.is_default ? 'none' : 'flex';
            document.getElementById('btn-nfo-delete').style.display = t.is_default ? 'none' : 'flex';
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function createNewNFOTemplate() {
    document.getElementById('nfo-template-id').value = '';
    document.getElementById('nfo-template-name').value = '';
    document.getElementById('nfo-template-description').value = '';
    document.getElementById('nfo-template-content').value = '';

    document.querySelectorAll('#nfo-templates-list .template-item').forEach(el => {
        el.classList.remove('active');
    });

    document.getElementById('btn-nfo-default').style.display = 'none';
    document.getElementById('btn-nfo-delete').style.display = 'none';
    document.getElementById('nfo-template-name').focus();
}

async function saveNFOTemplate() {
    const id = document.getElementById('nfo-template-id').value;
    const name = document.getElementById('nfo-template-name').value.trim();
    const description = document.getElementById('nfo-template-description').value.trim();
    const content = document.getElementById('nfo-template-content').value;

    if (!name) {
        showToast('Le nom du template est requis', 'error');
        return;
    }

    const url = id ? `/api/templates/nfo/${id}` : '/api/templates/nfo';
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description: description || null, content })
        });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast(id ? 'Template mis a jour' : 'Template cree', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function deleteNFOTemplate() {
    const id = document.getElementById('nfo-template-id').value;
    if (!id) return;

    if (!confirm('Supprimer ce template ?')) return;

    try {
        const response = await fetch(`/api/templates/nfo/${id}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template supprime', 'success');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function setNFOAsDefault() {
    const id = document.getElementById('nfo-template-id').value;
    if (!id) return;

    try {
        const response = await fetch(`/api/templates/nfo/${id}/set-default`, { method: 'POST' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template defini par defaut', 'success');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function insertNFOVariable(varName) {
    const editor = document.getElementById('nfo-template-content');
    const start = editor.selectionStart;
    const text = editor.value;
    const varText = '{{' + varName + '}}';

    editor.value = text.substring(0, start) + varText + text.substring(start);
    editor.focus();
    editor.setSelectionRange(start + varText.length, start + varText.length);
}

// ============================================================================
// Utility Functions
// ============================================================================

function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}

// ============================================================================
// Export/Import Functions
// ============================================================================

// Store imported data for confirmation
let pendingImportData = null;
let pendingImportType = null;

async function exportCurrentTemplate(type) {
    let id;
    if (type === 'bbcode') {
        id = document.getElementById('bbcode-template-id').value;
    } else if (type === 'naming') {
        id = document.getElementById('naming-template-id').value;
    } else if (type === 'nfo') {
        id = document.getElementById('nfo-template-id').value;
    }

    if (!id) {
        showToast('Aucun template selectionne', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/templates/${type}/${id}/export`);
        if (!response.ok) throw new Error('Export failed');

        const data = await response.json();
        const name = data.template?.name || type;
        downloadJSON(data, `${type}_${name}.json`);
        showToast('Template exporte', 'success');
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

async function exportAllTemplates(type) {
    try {
        const response = await fetch(`/api/templates/export-all/${type}`);
        if (!response.ok) throw new Error('Export failed');

        const data = await response.json();
        const count = data.templates?.length || 0;
        downloadJSON(data, `${type}_templates_all.json`);
        showToast(`${count} template(s) exporte(s)`, 'success');
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function downloadJSON(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename.replace(/[^a-zA-Z0-9._-]/g, '_');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function openImportModal(type) {
    pendingImportData = null;
    pendingImportType = type;

    document.getElementById('import-type').value = type;

    const typeNames = {
        'bbcode': 'BBCode',
        'naming': 'Nommage',
        'nfo': 'NFO'
    };
    document.getElementById('import-modal-title').textContent = `Importer des templates ${typeNames[type]}`;

    // Reset modal state
    document.getElementById('drop-zone').style.display = 'block';
    document.getElementById('import-file-info').style.display = 'none';
    document.getElementById('import-file').value = '';
    document.getElementById('btn-confirm-import').disabled = true;

    document.getElementById('import-modal').classList.add('active');
}

function closeImportModal() {
    document.getElementById('import-modal').classList.remove('active');
    pendingImportData = null;
    pendingImportType = null;
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        processImportFile(file);
    }
}

function handleFileDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.remove('drag-over');

    const file = event.dataTransfer.files[0];
    if (file && file.name.endsWith('.json')) {
        processImportFile(file);
    } else {
        showToast('Veuillez deposer un fichier JSON', 'error');
    }
}

async function processImportFile(file) {
    try {
        const text = await file.text();
        const data = JSON.parse(text);

        const expectedType = document.getElementById('import-type').value;
        if (data.type !== expectedType) {
            showToast(`Type invalide. Attendu: ${expectedType}, recu: ${data.type}`, 'error');
            return;
        }

        pendingImportData = { file, data };

        // Show file info
        document.getElementById('drop-zone').style.display = 'none';
        document.getElementById('import-file-info').style.display = 'block';
        document.getElementById('import-file-name').textContent = file.name;

        // Show preview
        const templates = data.templates || (data.template ? [data.template] : []);
        const preview = document.getElementById('import-preview');
        preview.innerHTML = templates.map(t => `
            <div class="import-preview-item">
                <svg class="preview-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="preview-name">${escapeHtml(t.name)}</span>
                ${t.description ? `<span class="preview-desc">${escapeHtml(t.description.substring(0, 30))}...</span>` : ''}
            </div>
        `).join('');

        document.getElementById('btn-confirm-import').disabled = false;

    } catch (error) {
        showToast('Fichier JSON invalide', 'error');
    }
}

function clearImportFile() {
    pendingImportData = null;
    document.getElementById('drop-zone').style.display = 'block';
    document.getElementById('import-file-info').style.display = 'none';
    document.getElementById('import-file').value = '';
    document.getElementById('btn-confirm-import').disabled = true;
}

async function confirmImport() {
    if (!pendingImportData) return;

    const type = document.getElementById('import-type').value;
    const conflictMode = document.getElementById('conflict-mode').value;

    const formData = new FormData();
    formData.append('file', pendingImportData.file);
    formData.append('conflict_mode', conflictMode);

    try {
        const response = await fetch(`/api/templates/${type}/import`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.status === 'success') {
            const imported = result.imported?.length || 0;
            const skipped = result.skipped?.length || 0;

            let message = `${imported} template(s) importe(s)`;
            if (skipped > 0) {
                message += `, ${skipped} ignore(s)`;
            }

            showToast(message, 'success');
            closeImportModal();
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || 'Erreur d\'import', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Initialize
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    // Load first template in each tab
    const firstBBCode = document.querySelector('#bbcode-templates-list .template-item');
    if (firstBBCode) loadBBCodeTemplate(parseInt(firstBBCode.dataset.id));

    const firstNaming = document.querySelector('#naming-templates-list .template-item');
    if (firstNaming) loadNamingTemplate(parseInt(firstNaming.dataset.id));

    const firstNFO = document.querySelector('#nfo-templates-list .template-item');
    if (firstNFO) loadNFOTemplate(parseInt(firstNFO.dataset.id));

    // Setup BBCode preview
    const bbcodeInput = document.getElementById('bbcode-template-content');
    if (bbcodeInput) {
        bbcodeInput.addEventListener('input', updateBBCodePreview);
        updateBBCodePreview();
    }

    // Setup naming preview
    const namingInput = document.getElementById('naming-template-content');
    if (namingInput) {
        namingInput.addEventListener('input', updateNamingPreview);
        updateNamingPreview();
    }

    // Setup drag and drop for import
    const dropZone = document.getElementById('drop-zone');
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', handleFileDrop);

        // Click to browse
        dropZone.addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT') {
                document.getElementById('import-file').click();
            }
        });
    }
});
{% endraw %}
</script>
{% endblock %}
