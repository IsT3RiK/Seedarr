<!-- Hidden input for current path (used by JavaScript) -->
<input type="hidden" id="current-path-value" value="{{ current_path }}">
<input type="hidden" id="filemanager-total" value="{{ total_count }}">

<!-- Breadcrumb Navigation -->
<div class="dashboard-card" style="padding: 0.75rem 1rem; margin-bottom: 1rem;">
    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
        <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
        </svg>
        {% for crumb in breadcrumbs %}
            {% if not loop.last %}
                <button
                    onclick='navigateTo({{crumb.path | tojson }})'
                    style="color: var(--accent-primary); background: none; border: none; cursor: pointer; font-size: 0.875rem; padding: 0;"
                    onmouseover="this.style.textDecoration='underline'"
                    onmouseout="this.style.textDecoration='none'"
                >
                    {{ crumb.name }}
                </button>
                <span style="color: var(--text-muted);">/</span>
            {% else %}
                <span style="font-weight: 600; color: var(--text-primary); font-size: 0.875rem;">{{ crumb.name }}</span>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Navigation Bar -->
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; gap: 1rem;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        {% if parent_path %}
        <button
            onclick='navigateTo({{parent_path | tojson }})'
            class="btn-secondary"
            style="padding: 0.375rem 0.75rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.375rem;"
        >
            <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
            </svg>
            Parent Folder
        </button>
        {% endif %}
    </div>
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <div style="position: relative;">
            <svg style="width: 1rem; height: 1rem; position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
                type="text"
                id="filemanager-search"
                placeholder="Search files..."
                class="form-input"
                style="padding: 0.375rem 0.75rem 0.375rem 2.25rem; font-size: 0.875rem; width: 14rem;"
                oninput="filterFiles(this.value)"
            >
        </div>
        <span style="font-size: 0.875rem; color: var(--text-muted); white-space: nowrap;">
            <span id="filemanager-count">{{ total_count }}</span> item(s)
        </span>
    </div>
</div>

<!-- File List -->
{% if items %}
<div class="dashboard-card" style="padding: 0; overflow: hidden;">
    <table class="dashboard-table">
        <thead>
            <tr>
                <th style="width: 3rem;"></th>
                <th>Name</th>
                <th style="width: 8rem; text-align: right;">Size</th>
                <th style="width: 10rem;">Modified</th>
                <th style="width: 12rem; text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody id="filemanager-table-body">
            {% for item in items %}
            <tr>
                <!-- Icon -->
                <td style="text-align: center;">
                    {% if item.is_dir %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--status-warning); display: inline-block;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path>
                        </svg>
                    {% elif item.type == 'video' %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--status-success); display: inline-block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    {% elif item.type == 'torrent' %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--status-info); display: inline-block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                    {% elif item.type == 'metadata' %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--accent-secondary); display: inline-block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    {% elif item.type == 'image' %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--accent-primary); display: inline-block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    {% else %}
                        <svg style="width: 1.25rem; height: 1.25rem; color: var(--text-muted); display: inline-block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    {% endif %}
                </td>

                <!-- Name -->
                <td>
                    {% if item.is_dir %}
                        <button
                            onclick='navigateTo({{item.path | tojson }})'
                            style="text-align: left; color: var(--text-primary); background: none; border: none; cursor: pointer; font-weight: 500; padding: 0;"
                            onmouseover="this.style.color='var(--accent-primary)'; this.style.textDecoration='underline'"
                            onmouseout="this.style.color='var(--text-primary)'; this.style.textDecoration='none'"
                        >
                            {{ item.name }}
                        </button>
                    {% else %}
                        <span style="{% if item.type == 'video' %}color: var(--status-success);{% endif %}">
                            {{ item.name }}
                        </span>
                        {% if item.extension %}
                            <span class="status-badge" style="padding: 0.125rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem; background-color: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--border-primary);">{{ item.extension }}</span>
                        {% endif %}
                    {% endif %}
                </td>

                <!-- Size -->
                <td style="text-align: right; color: var(--text-muted); font-family: monospace; font-size: 0.875rem;">
                    {{ item.size_formatted }}
                </td>

                <!-- Modified -->
                <td style="color: var(--text-muted); font-size: 0.875rem;">
                    {{ item.modified_formatted }}
                </td>

                <!-- Actions -->
                <td style="text-align: right;">
                    {% if item.is_dir %}
                        <div style="display: inline-flex; gap: 0.375rem;">
                            <button
                                onclick='navigateTo({{item.path | tojson }})'
                                class="btn-secondary"
                                style="padding: 0.25rem 0.625rem; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                                title="Open folder"
                            >
                                <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                                Open
                            </button>
                            <button
                                onclick='scanFile({{item.path | tojson }})'
                                class="btn-primary"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                title="Scan folder for videos"
                            >
                                <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </button>
                        </div>
                    {% elif item.type == 'video' %}
                        <div style="display: inline-flex; gap: 0.375rem;">
                            <button
                                onclick='checkDuplicate({{item.path | tojson }})'
                                class="btn-secondary"
                                style="padding: 0.25rem 0.625rem; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                                title="Check for duplicates on trackers"
                            >
                                <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Dup
                            </button>
                            <button
                                onclick='scanFile({{item.path | tojson }})'
                                class="btn-primary"
                                style="padding: 0.25rem 0.625rem; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                                title="Scan this video"
                            >
                                <svg style="width: 0.875rem; height: 0.875rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Scan
                            </button>
                        </div>
                    {% else %}
                        <span style="color: var(--text-muted); font-size: 0.75rem;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if has_more %}
            <tr id="scroll-sentinel" data-next-offset="{{ next_offset }}">
                <td colspan="5" style="text-align: center; padding: 1rem; color: var(--text-muted);">
                    <div class="loading-spinner" style="width: 1.5rem; height: 1.5rem; margin: 0 auto; border-width: 2px;"></div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% else %}
<!-- Empty State -->
<div class="dashboard-card" style="text-align: center; padding: 3rem;">
    <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; color: var(--text-muted); opacity: 0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
    </svg>
    <p style="color: var(--text-muted); font-size: 1.125rem;">This folder is empty</p>
    <p style="color: var(--text-muted); font-size: 0.875rem; opacity: 0.5; margin-top: 0.25rem;">No files or folders found in this directory</p>
</div>
{% endif %}

<!-- Legend -->
<div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.875rem; color: var(--text-muted);">
    <div style="display: flex; align-items: center; gap: 0.375rem;">
        <svg style="width: 1rem; height: 1rem; color: var(--status-warning);" fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path>
        </svg>
        <span>Folder</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.375rem;">
        <svg style="width: 1rem; height: 1rem; color: var(--status-success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg>
        <span>Video (scannable)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.375rem;">
        <svg style="width: 1rem; height: 1rem; color: var(--status-info);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
        </svg>
        <span>Torrent</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.375rem;">
        <svg style="width: 1rem; height: 1rem; color: var(--accent-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span>NFO/Text</span>
    </div>
</div>
