<!-- Queue Rows Partial - Used for infinite scroll load-more -->
{% for job in jobs %}
<tr class="job-row" onclick="window.location='/release/{{ job.id }}'" style="cursor: pointer;">
    <td class="job-name-cell">
        <a href="/release/{{ job.id }}" class="job-link" onclick="event.stopPropagation();">
            <div class="font-medium text-primary hover:text-accent job-name-text" title="{{ job.filename }}">{{ job.filename }}</div>
        </a>
        <div class="text-sm text-muted">
            {% if job.release_name %}
                <span class="job-release-name" title="{{ job.release_name }}">{{ job.release_name[:50] }}{% if job.release_name|length > 50 %}...{% endif %}</span>
            {% else %}
                {% if job.file_size %}
                    {% if job.file_size > 1073741824 %}
                        {{ "%.1f"|format(job.file_size / 1073741824) }} GB
                    {% elif job.file_size > 1048576 %}
                        {{ "%.1f"|format(job.file_size / 1048576) }} MB
                    {% else %}
                        {{ "%.1f"|format(job.file_size / 1024) }} KB
                    {% endif %}
                {% else %}
                    Size unknown
                {% endif %}
            {% endif %}
        </div>
    </td>
    <td>
        <div class="flex items-center gap-2">
            <div class="stage-badge stage-{{ job.current_stage|lower|replace(' ', '-') }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
            </div>
            <span>{{ job.current_stage }}</span>
        </div>
    </td>
    <td>
        {% if job.duplicate_check_results %}
            {% if job.duplicate_check_results.has_duplicates %}
            <div id="dup-status-{{ job.id }}" class="dup-status dup-yes" data-job-id="{{ job.id }}">
                <div class="dup-badge-container">
                    <button class="dup-badge dup-badge-yes" onclick="event.stopPropagation(); checkDuplicates({{ job.id }})">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        YES
                    </button>
                    <div class="dup-popup">
                        <div class="dup-popup-header">Duplicates Found</div>
                        <div class="dup-popup-content">
                            {% for slug, data in job.duplicate_check_results.results.items() %}
                                {% if data.is_duplicate and data.existing_torrents %}
                                <div class="dup-tracker-block">
                                    <div class="dup-tracker-header">
                                        <span class="dup-tracker-icon">&#128279;</span>
                                        {{ data.tracker_name }}
                                        <span class="dup-count">({{ data.existing_torrents|length }})</span>
                                    </div>
                                    <ul class="dup-release-list">
                                        {% for torrent in data.existing_torrents[:5] %}
                                        <li>{{ torrent.title }}</li>
                                        {% endfor %}
                                        {% if data.existing_torrents|length > 5 %}
                                        <li class="dup-more-item">+{{ data.existing_torrents|length - 5 }} more...</li>
                                        {% endif %}
                                    </ul>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div id="dup-status-{{ job.id }}" class="dup-status dup-no" data-job-id="{{ job.id }}">
                <div class="dup-indicator" onclick="event.stopPropagation(); checkDuplicates({{ job.id }})" title="Click to refresh">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>NO</span>
                </div>
            </div>
            {% endif %}
        {% else %}
        <div id="dup-status-{{ job.id }}" class="dup-status dup-unknown" data-job-id="{{ job.id }}">
            <button class="dup-check-btn" onclick="event.stopPropagation(); checkDuplicates({{ job.id }})" title="Check for duplicates">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="dup-label">Check</span>
            </button>
        </div>
        {% endif %}
    </td>
    <td>
        {% if job.tracker_statuses %}
        <div class="tracker-status-badges" style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
            {% for slug, status_data in job.tracker_statuses.items() %}
            <div class="tracker-badge tracker-{{ status_data.status }}"
                 title="{{ status_data.error or status_data.torrent_url or '' }}"
                 style="padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;
                 {% if status_data.status == 'success' %}background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid #22c55e;
                 {% elif status_data.status == 'failed' %}background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444;
                 {% elif status_data.status == 'skipped_duplicate' %}background: rgba(251, 146, 60, 0.1); color: #fb923c; border: 1px solid #fb923c;
                 {% elif status_data.status == 'retrying' %}background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid #3b82f6;
                 {% else %}background: rgba(156, 163, 175, 0.1); color: #9ca3af; border: 1px solid #9ca3af;{% endif %}">
                {% if status_data.status == 'success' %}
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                {% elif status_data.status == 'failed' %}
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                {% elif status_data.status == 'skipped_duplicate' %}
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-14a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2h-2zm1 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                {% else %}
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                {% endif %}
                {{ slug }}
                {% if status_data.status == 'failed' %}
                <button class="btn-retry-tracker" onclick="event.stopPropagation(); retryTracker({{ job.id }}, '{{ slug }}')" title="Retry {{ slug }}">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <span class="text-muted text-sm">-</span>
        {% endif %}
    </td>
    <td>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ job.progress }}%"></div>
            </div>
            <div class="text-sm text-muted mt-1">{{ job.progress }}%</div>
        </div>
    </td>
    <td class="text-muted">
        {% if job.created_at %}
            {{ job.created_at.strftime('%Y-%m-%d %H:%M') }}
        {% else %}
            Unknown
        {% endif %}
    </td>
    <td onclick="event.stopPropagation();">
        <div class="flex gap-2">
            <a
                href="/release/{{ job.id }}"
                class="btn-icon btn-details"
                title="View details"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </a>
            <button
                class="btn-icon btn-process"
                title="Process this job"
                hx-post="/api/queue/process/{{ job.id }}"
                hx-target="#process-result"
                hx-swap="innerHTML"
            >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                </svg>
            </button>
            <button
                class="btn-icon btn-delete"
                title="Delete from queue"
                hx-delete="/api/queue/delete/{{ job.id }}"
                hx-target="#queue-content"
                hx-swap="outerHTML"
                hx-confirm="Are you sure you want to delete this job?"
            >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </td>
</tr>
{% endfor %}

{% if has_more %}
<tr id="load-more-trigger"
    hx-get="/api/queue/load-more?offset={{ next_offset }}&limit={{ limit }}&search={{ search|urlencode }}"
    hx-trigger="intersect once threshold:0.5"
    hx-swap="outerHTML"
    hx-target="this">
    <td colspan="7" class="text-center py-4">
        <div class="loading-indicator">
            <svg class="animate-spin h-5 w-5 text-accent inline-block mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading more...
        </div>
    </td>
</tr>
{% endif %}
