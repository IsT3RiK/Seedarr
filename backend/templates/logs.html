{% extends "base.html" %}

{% block title %}Logs - Seedarr v2.0{% endblock %}
{% block page_title %}Logs{% endblock %}

{% block extra_head %}
<style>
    /* Terminal-style log viewer */
    .log-viewer {
        background: #000;
        border: 1px solid var(--border-primary);
        border-radius: 0.5rem;
        padding: 1.5rem;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        color: #00ff00;
        max-height: 600px;
        overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .log-viewer::-webkit-scrollbar {
        width: 8px;
    }

    .log-viewer::-webkit-scrollbar-track {
        background: #0a0a0a;
    }

    .log-viewer::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }

    .log-viewer::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .log-entry {
        margin-bottom: 0.25rem;
        padding: 0.25rem 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .log-timestamp {
        color: #888;
        font-weight: 600;
    }

    .log-level {
        font-weight: 700;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        margin: 0 0.5rem;
    }

    .log-level-info {
        color: #00bfff;
    }

    .log-level-warning {
        color: #ffa500;
    }

    .log-level-error {
        color: #ff4444;
    }

    .log-level-success {
        color: #00ff00;
    }

    .log-level-debug {
        color: #9370db;
    }

    .log-message {
        color: #e0e0e0;
    }

    .log-section {
        margin-bottom: 2rem;
    }

    .log-section-header {
        background: var(--bg-tertiary);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .log-section-header:hover {
        background: var(--bg-secondary);
    }

    .log-section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .log-section-content {
        display: block;
    }

    .log-section-content.collapsed {
        display: none;
    }

    .collapse-icon {
        transition: transform 0.2s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-90deg);
    }

    .filter-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .filter-badge.active {
        border-color: var(--accent-primary);
        background: rgba(6, 182, 212, 0.1);
    }

    .auto-scroll-indicator {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .auto-scroll-indicator.active::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #00ff00;
        animation: pulse 2s ease-in-out infinite;
    }

    .docker-log-viewer {
        background: #0a0a0a;
        border: 1px solid var(--border-primary);
        border-radius: 0.5rem;
        padding: 1.5rem;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        color: #a0a0a0;
        max-height: 600px;
        overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .docker-log-viewer::-webkit-scrollbar {
        width: 8px;
    }

    .docker-log-viewer::-webkit-scrollbar-track {
        background: #050505;
    }

    .docker-log-viewer::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }

    .docker-log-viewer::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Logs Header with Controls -->
    <div class="dashboard-header">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="dashboard-title">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Application Logs
                </h1>
                <p class="dashboard-subtitle">Real-time system logs and activity monitoring</p>
            </div>
            <div class="flex gap-2">
                <button
                    class="btn-secondary"
                    hx-post="/api/logs/test"
                    hx-target="#message-container"
                    hx-swap="innerHTML"
                    style="background-color: rgba(139, 92, 246, 0.1); color: #8b5cf6; border-color: #8b5cf6;"
                    title="Generate test logs for all levels"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Test
                </button>
                <button
                    class="btn-secondary"
                    hx-get="/api/logs/download"
                    hx-swap="none"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download
                </button>
                <button
                    class="btn-secondary"
                    hx-post="/api/logs/clear"
                    hx-target="#logs-content"
                    hx-swap="innerHTML"
                    hx-confirm="Are you sure you want to clear the logs? This action cannot be undone."
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Clear
                </button>
                <button
                    class="btn-primary"
                    hx-get="/api/logs/refresh"
                    hx-target="#log-viewer"
                    hx-swap="outerHTML"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="message-container" class="mb-4"></div>

    <!-- Log Filters -->
    <div class="dashboard-card">
        <div class="card-body">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex gap-2 flex-wrap">
                    <span class="text-muted">Filter by level:</span>
                    <button
                        class="filter-badge active"
                        hx-get="/api/logs/filter?level=all"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span>All</span>
                    </button>
                    <button
                        class="filter-badge"
                        hx-get="/api/logs/filter?level=info"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span class="log-level-info">●</span>
                        <span>Info</span>
                    </button>
                    <button
                        class="filter-badge"
                        hx-get="/api/logs/filter?level=success"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span class="log-level-success">●</span>
                        <span>Success</span>
                    </button>
                    <button
                        class="filter-badge"
                        hx-get="/api/logs/filter?level=warning"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span class="log-level-warning">●</span>
                        <span>Warning</span>
                    </button>
                    <button
                        class="filter-badge"
                        hx-get="/api/logs/filter?level=error"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span class="log-level-error">●</span>
                        <span>Error</span>
                    </button>
                    <button
                        class="filter-badge"
                        hx-get="/api/logs/filter?level=debug"
                        hx-target="#log-viewer"
                        hx-swap="outerHTML"
                        onclick="setActiveFilter(this)"
                    >
                        <span class="log-level-debug">●</span>
                        <span>Debug</span>
                    </button>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="auto-scroll" class="checkbox checkbox-sm checkbox-primary" checked onchange="toggleAutoScroll()">
                        <span class="auto-scroll-indicator active" id="auto-scroll-indicator">Auto-scroll</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logs Section -->
    <div id="logs-content" class="log-section">
        <div class="log-section-header" onclick="toggleSection('app-logs')">
            <div class="log-section-title">
                <svg class="w-5 h-5 collapse-icon" id="app-logs-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Application Logs</span>
            </div>
            <span class="text-sm text-muted">Last updated: 2 seconds ago</span>
        </div>
        <div class="log-section-content" id="app-logs-content">
            <div class="log-viewer" id="log-viewer">
                {% if log_entries %}
                    {% for entry in log_entries %}
                    <div class="log-entry" data-level="{{ entry.level|lower }}">
                        <span class="log-timestamp">[{{ entry.timestamp }}]</span>
                        <span class="log-level log-level-{{ entry.level|lower }}">[{{ entry.level|upper }}]</span>
                        <span class="log-message">{{ entry.message }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="log-entry" data-level="info">
                        <span class="log-timestamp">[--]</span>
                        <span class="log-level log-level-info">[INFO]</span>
                        <span class="log-message">No logs available. Application logs will appear here as events occur.</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Docker Container Logs Section -->
    <div class="log-section">
        <div class="log-section-header" onclick="toggleSection('docker-logs')">
            <div class="log-section-title">
                <svg class="w-5 h-5 collapse-icon" id="docker-logs-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span>Docker Container Logs</span>
            </div>
            <div class="flex gap-2">
                <button
                    class="btn-secondary btn-sm"
                    hx-get="/api/logs/docker?lines=100"
                    hx-target="#docker-log-viewer"
                    hx-swap="outerHTML"
                    title="Refresh Docker logs"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="log-section-content" id="docker-logs-content">
            <div class="docker-log-viewer" id="docker-log-viewer"
                hx-get="/api/logs/docker?lines=100"
                hx-trigger="load"
                hx-swap="outerHTML">
                <div class="log-entry">
                    <span class="log-timestamp">[--]</span>
                    <span class="log-message">Loading Docker logs...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Log Entries</div>
            <div class="stat-value">{{ log_stats.total if log_stats else 0 }}</div>
            <div class="stat-change">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                Current session
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Errors</div>
            <div class="stat-value">{{ log_stats.errors if log_stats else 0 }}</div>
            <div class="stat-change">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Current session
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Warnings</div>
            <div class="stat-value">{{ log_stats.warnings if log_stats else 0 }}</div>
            <div class="stat-change">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Current session
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value">{{ log_stats.success_rate if log_stats else 100 }}%</div>
            <div class="stat-change positive">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Operations completed
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let autoScroll = true;
    let currentFilter = 'all';

    // Auto-scroll to bottom of log viewer
    function scrollToBottom() {
        if (autoScroll) {
            const logViewer = document.getElementById('log-viewer');
            if (logViewer) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        }
    }

    // Toggle auto-scroll
    function toggleAutoScroll() {
        autoScroll = document.getElementById('auto-scroll').checked;
        const indicator = document.getElementById('auto-scroll-indicator');
        if (autoScroll) {
            indicator.classList.add('active');
            scrollToBottom();
        } else {
            indicator.classList.remove('active');
        }
    }

    // Toggle collapsible log sections
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + '-content');
        const icon = document.getElementById(sectionId + '-icon');

        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            icon.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('collapsed');
        }
    }

    // Set active filter badge
    function setActiveFilter(button) {
        // Update active filter badge
        document.querySelectorAll('.filter-badge').forEach(badge => {
            badge.classList.remove('active');
        });
        button.classList.add('active');
    }

    // Scroll to bottom after HTMX content swap
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'log-viewer' && autoScroll) {
            scrollToBottom();
        }
    });

    // Clear log viewer
    function clearLogs() {
        if (confirm('Are you sure you want to clear the log viewer? This will not delete log files.')) {
            document.getElementById('log-viewer').innerHTML = '<div class="log-entry"><span class="log-message">Logs cleared. Refresh to reload.</span></div>';
        }
    }

    // Download logs as text file
    function downloadLogs() {
        const logViewer = document.getElementById('log-viewer');
        const logText = logViewer.innerText;
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logs-${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // Scroll to bottom on page load
    window.addEventListener('load', () => {
        scrollToBottom();
    });

    // Simulate new log entries (for demo purposes)
    setInterval(() => {
        if (autoScroll) {
            scrollToBottom();
        }
    }, 1000);
</script>
{% endblock %}
