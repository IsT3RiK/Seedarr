{% extends "base.html" %}

{% block title %}BBCode Templates - Seedarr{% endblock %}

{% block page_title %}BBCode Templates{% endblock %}

{% block content %}
<div class="templates-container">
    <!-- Left Panel: Templates List -->
    <div class="templates-sidebar">
        <div class="sidebar-header">
            <h2>Mes Templates</h2>
            <button class="btn btn-primary btn-sm" onclick="createNewTemplate()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Nouveau
            </button>
        </div>
        <div class="templates-list" id="templates-list">
            {% for template in templates %}
            <div class="template-item {% if loop.first %}active{% endif %}"
                 data-id="{{ template.id }}"
                 onclick="loadTemplate({{ template.id }})">
                <div class="template-item-header">
                    <span class="template-name">{{ template.name }}</span>
                    {% if template.is_default %}
                    <span class="badge-default">Defaut</span>
                    {% endif %}
                </div>
                <div class="template-item-meta">
                    {{ template.updated_at.strftime('%d/%m/%Y %H:%M') if template.updated_at else '' }}
                </div>
            </div>
            {% else %}
            <div class="empty-list">
                <p>Aucun template</p>
                <button class="btn btn-primary btn-sm" onclick="createNewTemplate()">Creer un template</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content: Editor + Preview -->
    <div class="editor-main">
        <!-- Editor Header -->
        <div class="editor-header">
            <div class="editor-title-row">
                <input type="text" id="template-name" class="input-title" placeholder="Nom du template" value="">
                <input type="hidden" id="template-id" value="">
            </div>
            <div class="editor-actions">
                <button class="btn btn-secondary" onclick="setAsDefault()" id="btn-set-default" title="Definir par defaut">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                </button>
                <button class="btn btn-danger" onclick="deleteCurrentTemplate()" id="btn-delete" title="Supprimer">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
                <button class="btn btn-primary" onclick="saveTemplate()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Sauvegarder
                </button>
            </div>
        </div>

        <!-- Description -->
        <div class="editor-description">
            <input type="text" id="template-description" class="input-description" placeholder="Description du template (optionnel)">
        </div>

        <!-- Variables Panel with Accordions -->
        <div class="variables-panel">
            <!-- TMDB Variables -->
            <details class="variables-accordion" open>
                <summary class="accordion-header">
                    <span class="accordion-title">
                        <svg class="accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                        </svg>
                        TMDB
                    </span>
                    <span class="accordion-count">{{ variables.tmdb|length }} variables</span>
                </summary>
                <div class="variables-chips">
                    {% for key, desc in variables.tmdb.items() %}
                    <button class="var-chip var-chip-tmdb" onclick="insertVariable('{{ key }}')" title="{{ desc }}">{{ key }}</button>
                    {% endfor %}
                </div>
            </details>

            <!-- Cast Variables -->
            <details class="variables-accordion">
                <summary class="accordion-header">
                    <span class="accordion-title">
                        <svg class="accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Casting
                    </span>
                    <span class="accordion-count">{{ variables.cast|length }} variables</span>
                </summary>
                <div class="variables-chips">
                    {% for key, desc in variables.cast.items() %}
                    <button class="var-chip var-chip-cast" onclick="insertVariable('{{ key }}')" title="{{ desc }}">{{ key }}</button>
                    {% endfor %}
                </div>
            </details>

            <!-- MediaInfo Variables -->
            <details class="variables-accordion">
                <summary class="accordion-header">
                    <span class="accordion-title">
                        <svg class="accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        MediaInfo
                    </span>
                    <span class="accordion-count">{{ variables.mediainfo|length }} variables</span>
                </summary>
                <div class="variables-chips">
                    {% for key, desc in variables.mediainfo.items() %}
                    <button class="var-chip var-chip-media" onclick="insertVariable('{{ key }}')" title="{{ desc }}">{{ key }}</button>
                    {% endfor %}
                </div>
            </details>
        </div>

        <!-- BBCode Toolbar -->
        <div class="bbcode-toolbar">
            <button type="button" class="toolbar-btn" onclick="insertBBCode('b')" title="Gras"><b>B</b></button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('i')" title="Italique"><i>I</i></button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('u')" title="Souligne"><u>U</u></button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('center')" title="Centrer">Center</button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('quote')" title="Citation">Quote</button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('img')" title="Image">Img</button>
            <button type="button" class="toolbar-btn" onclick="insertBBCodeWithAttr('color', '#eab308')" title="Couleur">Color</button>
            <button type="button" class="toolbar-btn" onclick="insertBBCodeWithAttr('size', '6')" title="Taille">Size</button>
            <button type="button" class="toolbar-btn" onclick="insertBBCode('url')" title="Lien">URL</button>
        </div>

        <!-- Split View: Editor + Preview -->
        <div class="split-view">
            <!-- Code Editor -->
            <div class="editor-pane">
                <div class="pane-header">
                    <span>Code BBCode</span>
                </div>
                <textarea id="template-content" class="code-editor" placeholder="Entrez votre template BBCode ici...
Utilisez les variables comme {{title}}, {{year}}, {{poster_url}}, etc."></textarea>
            </div>

            <!-- Live Preview -->
            <div class="preview-pane">
                <div class="pane-header">
                    <span>Apercu en direct</span>
                    <div class="preview-controls">
                        <button class="btn-expand" onclick="openPreviewModal()" title="Agrandir l'apercu">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                        </button>
                        <div class="preview-toggle">
                            <button class="toggle-btn active" id="btn-preview-html" onclick="setPreviewMode('html')">Rendu</button>
                            <button class="toggle-btn" id="btn-preview-bbcode" onclick="setPreviewMode('bbcode')">BBCode</button>
                        </div>
                    </div>
                </div>
                <div id="preview-content" class="preview-area">
                    <div class="preview-placeholder">
                        Commencez a editer pour voir l'apercu...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal" onclick="closePreviewModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>Apercu du template</h3>
            <div class="modal-controls">
                <div class="preview-toggle">
                    <button class="toggle-btn active" id="btn-modal-html" onclick="setModalPreviewMode('html')">Rendu</button>
                    <button class="toggle-btn" id="btn-modal-bbcode" onclick="setModalPreviewMode('bbcode')">BBCode</button>
                </div>
                <button class="btn-close" onclick="closePreviewModal()" title="Fermer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="modal-preview-content" class="modal-preview-area html-mode">
        </div>
    </div>
</div>

<style>
/* Color Overrides for Better Readability */
* {
    --text-primary: #e8e9ea !important;
    --text-secondary: #d4d6d8 !important;
    --text-muted: #94a3b8 !important;
    --text-cream: #f0f1f2 !important;
}

/* Ensure all SVG icons are visible */
.btn svg,
.accordion-title svg,
.accordion-icon {
    stroke: currentColor;
    fill: none;
}

.btn-primary svg,
.btn-primary:hover svg {
    stroke: #f0f1f2 !important;
}

.btn-secondary svg,
.btn-danger svg {
    stroke: #d4d6d8;
}

.btn:hover svg {
    stroke: #e8e9ea;
}

/* Main Container */
.templates-container {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    max-width: 100%;
    min-height: calc(100vh - 120px);
    color: #e8e9ea;
}

/* Sidebar */
.templates-sidebar {
    width: 240px;
    min-width: 240px;
    max-width: 240px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    display: flex;
    flex-direction: column;
    align-self: flex-start;
    position: sticky;
    top: 1rem;
    max-height: calc(100vh - 140px);
    overflow: hidden;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-header h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: #e8e9ea;
}

.templates-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.template-item {
    padding: 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.25rem;
    border: 1px solid transparent;
}

.template-item:hover {
    background: var(--bg-tertiary);
}

.template-item.active {
    background: rgba(234, 179, 8, 0.1);
    border-color: var(--accent-color);
}

.template-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

.template-name {
    font-weight: 500;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #d4d6d8;
}

.badge-default {
    background: var(--accent-color);
    color: #0f172a;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
}

.template-item-meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.empty-list {
    text-align: center;
    padding: 2rem 1rem;
    color: #94a3b8;
}

.empty-list p {
    color: #bfc3c7;
}

/* Editor Main */
.editor-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    min-width: 0;
}

.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 1rem;
}

.editor-title-row {
    flex: 1;
}

.input-title {
    width: 100%;
    background: transparent;
    border: none;
    font-size: 1.25rem;
    font-weight: 600;
    color: #e8e9ea !important;
    padding: 0.25rem 0;
}

.input-title:focus {
    outline: none;
    color: #fbbf24 !important;
}

.input-title::placeholder {
    color: #64748b;
    opacity: 0.8;
}

.editor-actions {
    display: flex;
    gap: 0.5rem;
}

.editor-description {
    padding: 0 1rem 0.5rem 1rem;
}

.input-description {
    width: 100%;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(100, 116, 139, 0.4);
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: #d4d6d8 !important;
}

.input-description::placeholder {
    color: #64748b;
    opacity: 0.9;
}

.code-editor::placeholder,
.input-title::placeholder,
.input-description::placeholder {
    color: #64748b !important;
    opacity: 0.8 !important;
}

.input-description:focus {
    outline: none;
    border-color: var(--accent-color);
    background: rgba(30, 41, 59, 0.8);
    color: #e8e9ea !important;
}

/* Variables Panel with Accordions */
.variables-panel {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    max-height: 300px;
    overflow-y: auto;
}

.variables-accordion {
    border: 1px solid rgba(100, 116, 139, 0.2);
    border-radius: 0.5rem;
    background: rgba(15, 23, 42, 0.3);
}

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    cursor: pointer;
    user-select: none;
    list-style: none;
    transition: all 0.2s;
}

.accordion-header:hover {
    background: rgba(59, 130, 246, 0.05);
}

.accordion-header::-webkit-details-marker {
    display: none;
}

.accordion-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 700;
    color: #fbbf24;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.accordion-icon {
    width: 18px;
    height: 18px;
    stroke-width: 2.5;
}

.accordion-count {
    font-size: 0.7rem;
    color: #94a3b8;
    font-weight: 500;
}

details[open] > .accordion-header .accordion-count {
    color: #bfc3c7;
}

.variables-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    padding: 0.75rem 1rem 1rem;
}

.var-chip {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08));
    border: 1.5px solid rgba(96, 165, 250, 0.4);
    border-radius: 0.4rem;
    padding: 0.4rem 0.7rem;
    font-size: 0.75rem;
    font-family: 'Consolas', 'Courier New', monospace;
    color: #60a5fa;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.var-chip:hover {
    border-color: #3b82f6;
    color: #93c5fd;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
}

.var-chip-tmdb {
    border-color: rgba(96, 165, 250, 0.4);
    color: #60a5fa;
}

.var-chip-tmdb:hover {
    border-color: #3b82f6;
    color: #93c5fd;
}

.var-chip-cast {
    background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(147, 51, 234, 0.08));
    border-color: rgba(168, 85, 247, 0.4);
    color: #a78bfa;
}

.var-chip-cast:hover {
    border-color: #9333ea;
    color: #c4b5fd;
    background: linear-gradient(135deg, rgba(147, 51, 234, 0.25), rgba(147, 51, 234, 0.15));
    box-shadow: 0 4px 6px rgba(147, 51, 234, 0.2);
}

.var-chip-media {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
    border-color: rgba(74, 222, 128, 0.4);
    color: #4ade80;
}

.var-chip-media:hover {
    border-color: #22c55e;
    color: #86efac;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.15));
    box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
}

/* BBCode Toolbar */
.bbcode-toolbar {
    display: flex;
    gap: 0.35rem;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
}

.toolbar-btn {
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid rgba(100, 116, 139, 0.3);
    border-radius: 0.375rem;
    padding: 0.4rem 0.7rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #94a3b8;
    cursor: pointer;
    transition: all 0.15s;
    min-width: 42px;
}

.toolbar-btn:hover {
    border-color: var(--accent-color);
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
    transform: translateY(-1px);
}

/* Split View */
.split-view {
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

.editor-pane {
    width: 50%;
    min-width: 350px;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    min-height: 0;
}

.preview-pane {
    width: 50%;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
}

.pane-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(30, 41, 59, 0.6);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #94a3b8;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.code-editor {
    flex: 1;
    width: 100%;
    background: #0f172a;
    border: none;
    padding: 1rem;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
    line-height: 1.6;
    color: #d4d6d8;
    resize: none;
    min-height: 400px;
}

.code-editor::placeholder {
    color: #64748b;
    opacity: 1;
}

.code-editor:focus {
    outline: none;
}

.preview-area {
    flex: 1;
    padding: 1rem;
    background: #0f172a;
    overflow-y: auto;
}

.preview-placeholder {
    color: #64748b;
    text-align: center;
    padding: 2rem;
    font-style: italic;
    font-size: 0.9rem;
}

/* Preview Toggle */
.preview-toggle {
    display: flex;
    background: rgba(15, 23, 42, 0.8);
    border-radius: 0.375rem;
    padding: 0.2rem;
    gap: 0.2rem;
}

.toggle-btn {
    background: transparent;
    border: 1px solid transparent;
    padding: 0.3rem 0.6rem;
    font-size: 0.65rem;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    border-radius: 0.25rem;
    transition: all 0.15s;
}

.toggle-btn:hover {
    color: #94a3b8;
}

.toggle-btn.active {
    background: var(--accent-color);
    color: #0f172a;
    border-color: var(--accent-color);
    font-weight: 700;
}

/* Preview Styles */
.preview-area.bbcode-mode {
    font-family: 'Consolas', monospace;
    font-size: 0.75rem;
    white-space: pre-wrap;
    word-break: break-word;
}

.preview-area.html-mode {
    line-height: 1.6;
}

.preview-area img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 0.5rem auto;
    display: block;
}

.preview-area img[src*="w185"],
.preview-area img[src*="w138"] {
    max-width: 120px;
    display: inline-block;
    margin: 0.25rem;
}

.preview-area blockquote {
    max-width: 600px;
    margin: 1rem auto;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: #d4d6d8;
}

.btn:hover {
    border-color: var(--accent-color);
    color: #e8e9ea;
}

.btn-sm {
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
}

.btn-primary {
    background: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: #f0f1f2 !important;
    font-weight: 700 !important;
}

.btn-primary:hover {
    background: #d4a107 !important;
    color: #f0f1f2 !important;
    box-shadow: 0 4px 6px rgba(234, 179, 8, 0.3);
}

.btn-secondary {
    background: rgba(51, 65, 85, 0.6);
    border-color: rgba(100, 116, 139, 0.4);
    color: #d4d6d8;
}

.btn-secondary:hover {
    background: rgba(251, 191, 36, 0.15);
    border-color: var(--accent-color);
    color: #fbbf24;
}

.btn-danger {
    background: rgba(51, 65, 85, 0.6);
    border-color: rgba(100, 116, 139, 0.4);
    color: #d4d6d8;
}

.btn-danger:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: #ef4444;
    color: #fca5a5;
}

/* Preview Controls */
.preview-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-expand {
    background: rgba(51, 65, 85, 0.6);
    border: 1px solid rgba(100, 116, 139, 0.4);
    border-radius: 0.375rem;
    padding: 0.4rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-expand svg {
    width: 16px;
    height: 16px;
    stroke: #94a3b8;
}

.btn-expand:hover {
    background: rgba(251, 191, 36, 0.15);
    border-color: var(--accent-color);
}

.btn-expand:hover svg {
    stroke: #fbbf24;
}

/* Preview Modal */
.preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    animation: fadeIn 0.2s ease;
}

.preview-modal.open {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: rgba(30, 41, 59, 0.6);
    border-radius: 1rem 1rem 0 0;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #e8e9ea;
}

.modal-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-close {
    background: rgba(51, 65, 85, 0.6);
    border: 1px solid rgba(100, 116, 139, 0.4);
    border-radius: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close svg {
    width: 20px;
    height: 20px;
    stroke: #94a3b8;
}

.btn-close:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: #ef4444;
}

.btn-close:hover svg {
    stroke: #fca5a5;
}

.modal-preview-area {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
    background: #0f172a;
    border-radius: 0 0 1rem 1rem;
    line-height: 1.6;
}

.modal-preview-area.bbcode-mode {
    font-family: 'Consolas', monospace;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-word;
    color: #d4d6d8;
}

.modal-preview-area.html-mode {
    color: #e8e9ea;
}

.modal-preview-area img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 0.5rem auto;
    display: block;
}

.modal-preview-area img[src*="w185"],
.modal-preview-area img[src*="w138"] {
    max-width: 120px;
    display: inline-block;
    margin: 0.25rem;
}

.modal-preview-area blockquote {
    border-left: 3px solid #4a5568;
    padding-left: 1rem;
    margin: 1rem auto;
    max-width: 700px;
    color: #a0aec0;
    font-style: italic;
}

.modal-preview-area a {
    color: #60a5fa !important;
    text-decoration: underline;
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    color: #e8e9ea;
    font-weight: 500;
}

.toast.success {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
    color: #86efac;
}

.toast.error {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
    color: #fca5a5;
}

@keyframes slideIn {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Scrollbar Styling */
.variables-panel::-webkit-scrollbar {
    width: 6px;
}

.variables-panel::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.5);
    border-radius: 3px;
}

.variables-panel::-webkit-scrollbar-thumb {
    background: rgba(100, 116, 139, 0.5);
    border-radius: 3px;
}

.variables-panel::-webkit-scrollbar-thumb:hover {
    background: rgba(100, 116, 139, 0.7);
}

/* Responsive */
@media (max-width: 1400px) {
    .editor-pane {
        width: 45%;
        min-width: 300px;
    }
}

@media (max-width: 1200px) {
    .templates-sidebar {
        width: 220px;
        min-width: 220px;
    }
    .editor-pane {
        width: 40%;
        min-width: 280px;
    }
}

@media (max-width: 900px) {
    .templates-container {
        flex-direction: column;
    }

    .templates-sidebar {
        width: 100%;
        min-width: 100%;
        max-height: 200px;
    }

    .split-view {
        flex-direction: column;
    }

    .editor-pane {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }

    .preview-pane {
        width: 100%;
    }
}

/* Additional text readability improvements */
label, span:not(.var-chip):not(.accordion-title):not(.badge-default), p {
    color: #d4d6d8;
}

input:not([type="hidden"]), textarea {
    color: #d4d6d8 !important;
}

/* Ensure SVG visibility */
svg {
    color: currentColor;
}

/* Accordion styling */
.accordion-header:hover {
    background: rgba(59, 130, 246, 0.08);
}

details[open] > .accordion-header {
    background: rgba(251, 191, 36, 0.08);
}

details[open] > .accordion-header .accordion-title {
    color: #fbbf24;
}

/* Link colors in preview */
.preview-area a {
    color: #60a5fa !important;
    text-decoration: underline;
}

.preview-area a:hover {
    color: #93c5fd !important;
}

/* Make sure all buttons in the sidebar are visible */
.sidebar-header .btn-primary {
    background: var(--accent-color) !important;
    color: #f0f1f2 !important;
}

.sidebar-header .btn-primary svg {
    stroke: #f0f1f2 !important;
}

/* Ensure proper contrast for all interactive elements */
button {
    cursor: pointer;
    transition: all 0.2s ease;
}

button:active {
    transform: translateY(1px);
}
</style>

<script>
{% raw %}
// State
let currentTemplateId = null;
let previewMode = 'html';
let debounceTimer = null;

// Sample data for live preview (Harry Potter et l'Ordre du Phenix)
const sampleData = {
    // TMDB data
    title: "Harry Potter et l'Ordre du Phenix",
    original_title: "Harry Potter and the Order of the Phoenix",
    year: "2007",
    release_date: "mercredi 11 juillet 2007",
    poster_url: "https://image.tmdb.org/t/p/w500/s836PRwHkLjrOJrfW0eo7B4NJOf.jpg",
    backdrop_url: "https://image.tmdb.org/t/p/w1280/nnqWhdWjGL1zag8wgXCf3V9UGE9.jpg",
    rating: "7.7",
    rating_10: "7.7/10",
    genres: "Aventure, Fantastique, Famille",
    overview: "Alors qu'il entame sa cinquieme annee d'etudes a Poudlard, Harry decouvre que la communaute des sorciers refuse de croire au retour de Voldemort, preferant remettre en cause sa sante mentale et sa credibilite. Isole, incompris, Harry doit faire face seul a ses tourments. Le Ministere de la Magie envoie Dolores Ombrage pour enseigner la Defense contre les forces du Mal et prendre peu a peu le controle de l'ecole. Harry et ses amis decident alors de former en secret l'Armee de Dumbledore.",
    tagline: "La rebellion commence.",
    runtime: "2h et 18min",
    country: "Royaume-Uni",
    director: "David Yates",
    tmdb_id: "675",
    imdb_id: "tt0373889",
    tmdb_url: "https://www.themoviedb.org/movie/675",
    trailer_url: "https://www.youtube.com/watch?v=47PHhQgHvME",
    // Cast data (6 actors) - cast_X_card = photo+nom inline
    cast_names: "Daniel Radcliffe, Emma Watson, Rupert Grint, Gary Oldman, Ralph Fiennes, Helena Bonham Carter",
    cast_1_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/iPg0J9UzAlPj1fLEJNllpW9IhGe.jpg[/img]\nDaniel Radcliffe[/inline]",
    cast_1_name: "Daniel Radcliffe",
    cast_1_character: "Harry Potter",
    cast_2_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/A14lLCZYDhfYdBa0fFRpwMDiwRN.jpg[/img]\nEmma Watson[/inline]",
    cast_2_name: "Emma Watson",
    cast_2_character: "Hermione Granger",
    cast_3_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/q2KZZ0ltTEl7Sf8volNFV1JDEP4.jpg[/img]\nRupert Grint[/inline]",
    cast_3_name: "Rupert Grint",
    cast_3_character: "Ron Weasley",
    cast_4_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/2v9FVVBUrrkW2m3QOcYkuhq9A6o.jpg[/img]\nGary Oldman[/inline]",
    cast_4_name: "Gary Oldman",
    cast_4_character: "Sirius Black",
    cast_5_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/tJr9GcmGNHhLVVEH3i7QYbj6hBi.jpg[/img]\nRalph Fiennes[/inline]",
    cast_5_name: "Ralph Fiennes",
    cast_5_character: "Lord Voldemort",
    cast_6_card: "[inline][img]https://image.tmdb.org/t/p/w138_and_h175_face/DDeITcCpnBd0CkAIRPhggy9bt5.jpg[/img]\nHelena Bonham Carter[/inline]",
    cast_6_name: "Helena Bonham Carter",
    cast_6_character: "Bellatrix Lestrange",
    // MediaInfo data
    quality: "2160p UHD BluRay",
    format: "MKV",
    video_codec: "HEVC / H.265",
    video_bitrate: "18.5 Mb/s",
    resolution: "3840x2160",
    hdr: "Dolby Vision / HDR10",
    duration: "2h 18min",
    audio_list: "- Francais (VFF) : TrueHD Atmos 7.1 @ 4 800 kb/s\n- Anglais (VO) : TrueHD Atmos 7.1 @ 4 800 kb/s",
    audio_table: "[table][tr][td][b]Langue[/b][/td][td][b]Codec[/b][/td][td][b]Débit[/b][/td][/tr][tr][td]Français (VFF)[/td][td]TrueHD Atmos 7.1[/td][td]4 800 kb/s[/td][/tr][tr][td]Anglais (VO)[/td][td]TrueHD Atmos 7.1[/td][td]4 800 kb/s[/td][/tr][/table]",
    languages: "Francais (VFF), Anglais (VO)",
    subtitles: "Francais, Anglais",
    subtitles_table: "[table][tr][td][b]Langue[/b][/td][td][b]Format[/b][/td][td][b]Type[/b][/td][/tr][tr][td]Français[/td][td]PGS[/td][td]Complets[/td][/tr][tr][td]Anglais[/td][td]PGS[/td][td]Complets[/td][/tr][/table]",
    file_size: "52.4 GiB",
    file_count: "1",
    source: "UHD BluRay REMUX",
    release_name: "Harry.Potter.And.The.Order.Of.The.Phoenix.2007.UHD.BluRay.2160p.TrueHD.Atmos.7.1.HEVC.REMUX-FraMeSToR",
    release_team: "FraMeSToR"
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Load first template if exists
    const firstItem = document.querySelector('.template-item');
    if (firstItem) {
        loadTemplate(parseInt(firstItem.dataset.id));
    } else {
        createNewTemplate();
    }

    // Setup live preview
    const editor = document.getElementById('template-content');
    editor.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updatePreview, 150);
    });
});

// Load template
async function loadTemplate(id) {
    try {
        const response = await fetch(`/api/templates/${id}`);
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            const t = result.template;
            currentTemplateId = t.id;
            document.getElementById('template-id').value = t.id;
            document.getElementById('template-name').value = t.name;
            document.getElementById('template-description').value = t.description || '';
            document.getElementById('template-content').value = t.content || '';

            // Update active state in list
            document.querySelectorAll('.template-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.id) === id);
            });

            // Update buttons visibility
            document.getElementById('btn-delete').style.display = t.is_default ? 'none' : 'flex';
            document.getElementById('btn-set-default').style.display = t.is_default ? 'none' : 'flex';

            updatePreview();
        } else {
            showToast(result.detail || 'Erreur de chargement', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

// Create new template
function createNewTemplate() {
    currentTemplateId = null;
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-description').value = '';
    document.getElementById('template-content').value = getDefaultTemplateContent();

    // Deselect all items
    document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));

    // Show all buttons
    document.getElementById('btn-delete').style.display = 'none';
    document.getElementById('btn-set-default').style.display = 'none';

    updatePreview();
    document.getElementById('template-name').focus();
}

// Get default template content
function getDefaultTemplateContent() {
    return `[center]
[img]{{poster_url}}[/img]

[size=6][color=#eab308][b]{{title}} ({{year}})[/b][/color][/size]

[b]Note :[/b] {{rating}}
[b]Genre :[/b] {{genres}}

[quote]{{overview}}[/quote]

[color=#eab308][b]--- DETAILS TECHNIQUES ---[/b][/color]

[b]Qualite :[/b] {{quality}}
[b]Format :[/b] {{format}}
[b]Rendu :[/b] {{hdr}}
[b]Duree :[/b] {{duration}}
[b]Codec Video :[/b] {{video_codec}}

[b]Codec Audio :[/b]
{{audio_list}}

[b]Langues :[/b] {{languages}}
[b]Sous-titres :[/b] {{subtitles}}
[b]Taille :[/b] {{file_size}}
[/center]`;
}

// Save template
async function saveTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const description = document.getElementById('template-description').value.trim();
    const content = document.getElementById('template-content').value;

    if (!name) {
        showToast('Le nom du template est requis', 'error');
        document.getElementById('template-name').focus();
        return;
    }

    if (!content) {
        showToast('Le contenu du template est requis', 'error');
        return;
    }

    const id = document.getElementById('template-id').value;
    const url = id ? `/api/templates/${id}` : '/api/templates';
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description: description || null, content })
        });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast(id ? 'Template mis a jour' : 'Template cree', 'success');
            // Reload page to refresh list
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || result.message || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

// Delete template
async function deleteCurrentTemplate() {
    const id = document.getElementById('template-id').value;
    if (!id) return;

    const name = document.getElementById('template-name').value;
    if (!confirm(`Supprimer le template "${name}" ?`)) return;

    try {
        const response = await fetch(`/api/templates/${id}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template supprime', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || result.message || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

// Set as default
async function setAsDefault() {
    const id = document.getElementById('template-id').value;
    if (!id) return;

    try {
        const response = await fetch(`/api/templates/${id}/set-default`, { method: 'POST' });
        const result = await response.json();

        if (response.ok && result.status === 'success') {
            showToast('Template defini par defaut', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.detail || result.message || 'Erreur', 'error');
        }
    } catch (error) {
        showToast('Erreur: ' + error.message, 'error');
    }
}

// Variables that should be wrapped with [img] tags
const imageVariables = ['poster_url', 'backdrop_url'];

// Variables that should be wrapped with [url] tags
const urlVariables = ['tmdb_url', 'trailer_url'];

// Card variables (already contain full BBCode structure)
const cardVariables = ['cast_1_card', 'cast_2_card', 'cast_3_card', 'cast_4_card', 'cast_5_card', 'cast_6_card'];

// Insert variable at cursor with automatic tag wrapping
function insertVariable(varName) {
    const editor = document.getElementById('template-content');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;

    let varText;
    if (imageVariables.includes(varName)) {
        // Wrap with [img] tags
        varText = '[img]{' + '{' + varName + '}' + '}[/img]';
    } else if (urlVariables.includes(varName)) {
        // Wrap with [url] tags - user can add link text after
        varText = '[url={' + '{' + varName + '}' + '}]Lien[/url]';
    } else {
        varText = '{' + '{' + varName + '}' + '}';
    }

    editor.value = text.substring(0, start) + varText + text.substring(end);
    editor.focus();
    editor.setSelectionRange(start + varText.length, start + varText.length);
    updatePreview();
}

// Insert BBCode tag
function insertBBCode(tag) {
    const editor = document.getElementById('template-content');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;
    const selected = text.substring(start, end);
    const openTag = `[${tag}]`;
    const closeTag = `[/${tag}]`;

    editor.value = text.substring(0, start) + openTag + selected + closeTag + text.substring(end);
    editor.focus();
    editor.setSelectionRange(start + openTag.length, start + openTag.length + selected.length);
    updatePreview();
}

// Insert BBCode with attribute
function insertBBCodeWithAttr(tag, attr) {
    const editor = document.getElementById('template-content');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;
    const selected = text.substring(start, end);
    const openTag = `[${tag}=${attr}]`;
    const closeTag = `[/${tag}]`;

    editor.value = text.substring(0, start) + openTag + selected + closeTag + text.substring(end);
    editor.focus();
    editor.setSelectionRange(start + openTag.length, start + openTag.length + selected.length);
    updatePreview();
}

// Update live preview
function updatePreview() {
    const content = document.getElementById('template-content').value;
    const previewEl = document.getElementById('preview-content');

    if (!content.trim()) {
        previewEl.innerHTML = '<div class="preview-placeholder">Commencez a editer pour voir l\'apercu...</div>';
        previewEl.className = 'preview-area';
        return;
    }

    // Replace variables with sample data
    let rendered = content;

    // Process conditional blocks {{#var}}...{{/var}}
    rendered = rendered.replace(/\{\{#(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g, (match, varName, inner) => {
        const value = sampleData[varName] || "";
        return value ? inner : "";
    });

    for (const [key, value] of Object.entries(sampleData)) {
        const regex = new RegExp('\\{\\{' + key + '\\}\\}', 'g');
        rendered = rendered.replace(regex, value);
    }

    if (previewMode === 'html') {
        previewEl.innerHTML = bbcodeToHtml(rendered);
        previewEl.className = 'preview-area html-mode';
    } else {
        previewEl.textContent = rendered;
        previewEl.className = 'preview-area bbcode-mode';
    }
}

// Set preview mode
function setPreviewMode(mode) {
    previewMode = mode;
    document.getElementById('btn-preview-html').classList.toggle('active', mode === 'html');
    document.getElementById('btn-preview-bbcode').classList.toggle('active', mode === 'bbcode');
    updatePreview();
}

// BBCode to HTML converter
function bbcodeToHtml(bbcode) {
    let html = bbcode;

    // Store complex elements temporarily to protect them from HTML escaping
    const placeholders = [];

    // Extract [inline] blocks first (actor cards with photo + name)
    html = html.replace(/\[inline\]([\s\S]*?)\[\/inline\]/gi, (match, content) => {
        const idx = placeholders.length;
        // Extract image URL from content
        const imgMatch = content.match(/\[img\](.*?)\[\/img\]/i);
        const imgUrl = imgMatch ? imgMatch[1] : '';
        // Get name (everything after the [/img] tag)
        const name = content.replace(/\[img\].*?\[\/img\]/i, '').replace(/\\n|\n/g, '').trim();
        placeholders.push(`<div style="display:inline-block;text-align:center;margin:8px;vertical-align:top;width:130px;"><img src="${imgUrl}" style="max-width:120px;height:auto;border-radius:8px;display:block;margin:0 auto 8px auto;" onerror="this.style.display='none'" /><div style="font-size:11px;color:#d4d6d8;line-height:1.3;">${name}</div></div>`);
        return `__INLINE_PLACEHOLDER_${idx}__`;
    });

    // Extract [img] tags and replace with placeholders
    html = html.replace(/\[img\](.*?)\[\/img\]/gi, (match, url) => {
        const idx = placeholders.length;
        placeholders.push(`<img src="${url}" style="display:inline-block;max-width:300px;height:auto;border-radius:8px;margin:5px;vertical-align:middle;" onerror="this.style.display='none'" />`);
        return `__IMG_PLACEHOLDER_${idx}__`;
    });

    // Extract [url] tags
    html = html.replace(/\[url=(.*?)\]([\s\S]*?)\[\/url\]/gi, (match, url, text) => {
        const idx = placeholders.length;
        placeholders.push(`<a href="${url}" style="color:#60a5fa;">${text}</a>`);
        return `__URL_PLACEHOLDER_${idx}__`;
    });
    html = html.replace(/\[url\](.*?)\[\/url\]/gi, (match, url) => {
        const idx = placeholders.length;
        placeholders.push(`<a href="${url}" style="color:#60a5fa;">${url}</a>`);
        return `__URL_PLACEHOLDER_${idx}__`;
    });

    // Now escape HTML for the rest of the content
    html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Convert BBCode to HTML
    html = html.replace(/\[center\]([\s\S]*?)\[\/center\]/gi, '<div style="text-align:center;">$1</div>');
    html = html.replace(/\[h1\]([\s\S]*?)\[\/h1\]/gi, '<h1 style="font-size:1.8em;margin:0.5em 0;">$1</h1>');
    html = html.replace(/\[h2\]([\s\S]*?)\[\/h2\]/gi, '<h2 style="font-size:1.4em;margin:0.5em 0;">$1</h2>');
    html = html.replace(/\[h3\]([\s\S]*?)\[\/h3\]/gi, '<h3 style="font-size:1.2em;margin:0.4em 0;">$1</h3>');
    html = html.replace(/\[size=(\d+)\]([\s\S]*?)\[\/size\]/gi, (m, size, text) => {
        const px = parseInt(size) * 4 + 8;
        return `<span style="font-size:${px}px;">${text}</span>`;
    });
    html = html.replace(/\[color=(#?[\w]+)\]([\s\S]*?)\[\/color\]/gi, '<span style="color:$1;">$2</span>');
    html = html.replace(/\[b\]([\s\S]*?)\[\/b\]/gi, '<strong>$1</strong>');
    html = html.replace(/\[i\]([\s\S]*?)\[\/i\]/gi, '<em>$1</em>');
    html = html.replace(/\[u\]([\s\S]*?)\[\/u\]/gi, '<u>$1</u>');
    html = html.replace(/\[quote\]([\s\S]*?)\[\/quote\]/gi, '<blockquote style="border-left:3px solid #4a5568;padding-left:1rem;margin:1rem 0;color:#a0aec0;font-style:italic;">$1</blockquote>');

    // [table], [tr], [td]
    html = html.replace(/\[table\]([\s\S]*?)\[\/table\]/gi, '<table style="border-collapse:collapse;margin:0.5em auto;width:auto;">$1</table>');
    html = html.replace(/\[tr\]([\s\S]*?)\[\/tr\]/gi, '<tr>$1</tr>');
    html = html.replace(/\[td\]([\s\S]*?)\[\/td\]/gi, '<td style="padding:4px 12px;border:1px solid #4a5568;">$1</td>');

    html = html.replace(/\n/g, '<br>');

    // Restore all placeholders
    placeholders.forEach((content, idx) => {
        html = html.replace(`__INLINE_PLACEHOLDER_${idx}__`, content);
        html = html.replace(`__IMG_PLACEHOLDER_${idx}__`, content);
        html = html.replace(`__URL_PLACEHOLDER_${idx}__`, content);
    });

    return html;
}

// Show toast notification
function showToast(message, type = 'info') {
    // Remove existing toast
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}

// Modal state
let modalPreviewMode = 'html';

// Open preview modal
function openPreviewModal() {
    const modal = document.getElementById('preview-modal');
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
    updateModalPreview();

    // Sync mode buttons
    document.getElementById('btn-modal-html').classList.toggle('active', modalPreviewMode === 'html');
    document.getElementById('btn-modal-bbcode').classList.toggle('active', modalPreviewMode === 'bbcode');
}

// Close preview modal
function closePreviewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('preview-modal');
    modal.classList.remove('open');
    document.body.style.overflow = '';
}

// Set modal preview mode
function setModalPreviewMode(mode) {
    modalPreviewMode = mode;
    document.getElementById('btn-modal-html').classList.toggle('active', mode === 'html');
    document.getElementById('btn-modal-bbcode').classList.toggle('active', mode === 'bbcode');
    updateModalPreview();
}

// Update modal preview content
function updateModalPreview() {
    const content = document.getElementById('template-content').value;
    const modalPreviewEl = document.getElementById('modal-preview-content');

    if (!content.trim()) {
        modalPreviewEl.innerHTML = '<div class="preview-placeholder">Aucun contenu a afficher...</div>';
        modalPreviewEl.className = 'modal-preview-area';
        return;
    }

    // Replace variables with sample data
    let rendered = content;

    // Process conditional blocks {{#var}}...{{/var}}
    rendered = rendered.replace(/\{\{#(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g, (match, varName, inner) => {
        const value = sampleData[varName] || "";
        return value ? inner : "";
    });

    for (const [key, value] of Object.entries(sampleData)) {
        const regex = new RegExp('\\{\\{' + key + '\\}\\}', 'g');
        rendered = rendered.replace(regex, value);
    }

    if (modalPreviewMode === 'html') {
        modalPreviewEl.innerHTML = bbcodeToHtml(rendered);
        modalPreviewEl.className = 'modal-preview-area html-mode';
    } else {
        modalPreviewEl.textContent = rendered;
        modalPreviewEl.className = 'modal-preview-area bbcode-mode';
    }
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closePreviewModal();
    }
});
{% endraw %}
</script>
{% endblock %}
