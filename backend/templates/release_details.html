{% extends "base.html" %}

{% block title %}{{ release.display_name if release else 'Release Details' }} - Seedarr{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
<div class="release-page">
    {% if error %}
    <div class="error-container">
        <div class="error-icon">
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2>Release Not Found</h2>
        <p class="text-muted">{{ error }}</p>
        <a href="/queue" class="btn btn-primary mt-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Queue
        </a>
    </div>
    {% elif release %}

    <!-- Hero Header (compact) -->
    <div class="release-hero">
        {% if release.cover_url %}
        <div class="hero-backdrop" style="background-image: url('{{ release.cover_url }}')"></div>
        {% endif %}
        <div class="hero-gradient"></div>

        <div class="hero-content">
            <a href="/queue" class="back-link">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Queue
            </a>

            <div class="hero-main">
                {% if release.cover_url %}
                <img src="{{ release.cover_url }}" alt="Cover" class="hero-poster">
                {% else %}
                <div class="hero-poster-placeholder">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                    </svg>
                </div>
                {% endif %}

                <div class="hero-info">
                    <h1 class="hero-title">{{ release.display_name }}</h1>
                    <div class="hero-pills">
                        <span class="status-pill status-{{ release.status.value }}">{{ release.status_display }}</span>
                        {% if release.tmdb_id %}
                        <span class="tmdb-badge">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            TMDB {{ release.tmdb_id }}
                        </span>
                        {% endif %}
                        {% if release.mediainfo_raw and release.mediainfo.video %}
                        <span class="info-pill">{{ release.mediainfo.video.resolution }}</span>
                        {% endif %}
                        <span class="info-pill">{{ release.file_size_display }}</span>
                        <span class="info-pill">{{ release.progress }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Steps (4 steps) -->
    <div class="pipeline-section">
        <div class="pipeline-header">
            <h2>Processing Pipeline</h2>
            <div id="action-result"></div>
        </div>
        <div class="pipeline-steps">
            <!-- Scan & Analyze (combined) -->
            <div class="pipeline-step {% if release.analyzed_at %}completed{% elif not release.analyzed_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'scan_analyze')" {% if release.analyzed_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.analyzed_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Scan & Analyze</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <!-- Metadata -->
            <div class="pipeline-step {% if release.metadata_generated_at %}completed{% elif release.analyzed_at and not release.metadata_generated_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'metadata')" {% if release.metadata_generated_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.metadata_generated_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Metadata</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <!-- Upload -->
            <div class="pipeline-step {% if release.uploaded_at %}completed{% elif release.metadata_generated_at and not release.uploaded_at %}current{% endif %}">
                <button class="step-button step-upload" onclick="executeStep({{ release.id }}, 'upload')" {% if release.uploaded_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.uploaded_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Upload</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-grid">
        <!-- Left Column: Release Info (file + mediainfo merged) -->
        <div class="content-left">
            <div class="card">
                <div class="card-header">
                    <h3>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Release Info
                    </h3>
                </div>
                <div class="card-body">
                    {% if release.mediainfo_raw %}
                    <div class="release-info-grid">
                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Filename</span>
                                <span class="info-value mono">{{ release.filename }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Release Name</span>
                                <span class="info-value mono">{{ release.final_release_name or release.release_name or 'Not set' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Size</span>
                                <span class="info-value">{{ release.file_size_display }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Duration</span>
                                <span class="info-value">{{ release.mediainfo.duration_display }}</span>
                            </div>
                            <div class="info-row full">
                                <span class="info-label">Path</span>
                                <span class="info-value mono small">{{ release.file_path }}</span>
                            </div>
                        </div>

                        <div class="specs-columns">
                            <div class="spec-col">
                                <div class="spec-title">Video</div>
                                <div class="spec-grid">
                                    <div class="spec-item">
                                        <span class="spec-label">Codec</span>
                                        <span class="spec-value">{{ release.mediainfo.video.codec }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Resolution</span>
                                        <span class="spec-value">{{ release.mediainfo.video.resolution }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">FPS</span>
                                        <span class="spec-value">{{ release.mediainfo.video.frame_rate }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Bit Depth</span>
                                        <span class="spec-value">{{ release.mediainfo.video.bit_depth }}-bit</span>
                                    </div>
                                    {% if release.mediainfo.video.hdr %}
                                    <div class="spec-item highlight">
                                        <span class="spec-label">HDR</span>
                                        <span class="spec-value">Yes</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="spec-col">
                                <div class="spec-title">Audio</div>
                                <div class="spec-grid">
                                    <div class="spec-item">
                                        <span class="spec-label">Codec</span>
                                        <span class="spec-value">{{ release.mediainfo.audio.codec }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Channels</span>
                                        <span class="spec-value">{{ release.mediainfo.audio.channels }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Language</span>
                                        <span class="spec-value">{{ release.mediainfo.audio.language }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if release.tracker_upload_names %}
                        <div class="tracker-names-section">
                            <div class="spec-title">Titre par tracker</div>
                            <div class="tracker-names-list">
                                {% for t in release.tracker_upload_names %}
                                <div class="tracker-name-item" id="tracker-name-row-{{ t.slug }}">
                                    <span class="tracker-slug">{{ t.name }}</span>
                                    <div class="tracker-name-editable">
                                        <span class="tracker-name mono" id="tracker-name-display-{{ t.slug }}" onclick="startEditTrackerName('{{ t.slug }}', '{{ t.name }}', this)">{{ t.release_name }}{% if t.is_preview %} <span class="preview-badge">aperçu</span>{% endif %}</span>
                                        <input type="text" class="tracker-name-input mono" id="tracker-name-input-{{ t.slug }}" value="{{ t.release_name }}" style="display:none"
                                            onkeydown="handleTrackerNameKey(event, {{ release.id }}, '{{ t.slug }}')"
                                            onblur="cancelEditTrackerName('{{ t.slug }}')">
                                    </div>
                                    <button class="edit-btn" onclick="startEditTrackerName('{{ t.slug }}', '{{ t.name }}', document.getElementById('tracker-name-display-{{ t.slug }}'))" title="Éditer">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- No mediainfo yet -->
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">Filename</span>
                            <span class="info-value mono">{{ release.filename }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Size</span>
                            <span class="info-value">{{ release.file_size_display }}</span>
                        </div>
                        <div class="info-row full">
                            <span class="info-label">Path</span>
                            <span class="info-value mono small">{{ release.file_path }}</span>
                        </div>
                    </div>
                    <div class="empty-hint">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Run Scan & Analyze to get file details
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Tracker info -->
        <div class="content-right">
            <!-- Duplicate Check -->
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Duplicate Check</h3>
                    <button class="btn-icon" onclick="checkDuplicates({{ release.id }})" title="Refresh">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div class="card-body" id="duplicate-results-container">
                    {% if release.duplicate_check_results %}
                    <div class="dup-status {% if release.duplicate_check_results.has_duplicates %}warning{% else %}success{% endif %}">
                        {% if release.duplicate_check_results.has_duplicates %}
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Duplicates found</span>
                        {% else %}
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>No duplicates found</span>
                        {% endif %}
                    </div>

                    <div class="tracker-list">
                        {% for slug, data in release.duplicate_check_results.results.items() %}
                        <div class="tracker-item {% if data.exact_match %}has-exact-match{% elif data.is_duplicate %}has-dup{% endif %}">
                            <div class="tracker-header">
                                <span class="tracker-name">{{ data.tracker_name or slug }}</span>
                                {% if data.exact_match %}
                                <span class="dup-exact" title="Exact same file size - likely same release!">EXACT {{ data.exact_matches|length if data.exact_matches else 1 }}</span>
                                {% elif data.is_duplicate %}
                                <span class="dup-count">{{ data.existing_torrents|length if data.existing_torrents else 0 }}</span>
                                {% elif data.error %}
                                <span class="dup-error">Error</span>
                                {% else %}
                                <span class="dup-clear">Clear</span>
                                {% endif %}
                            </div>
                            {% if data.is_duplicate and data.existing_torrents %}
                            <div class="existing-list">
                                {% for torrent in data.existing_torrents %}
                                {% set exact_names = (data.exact_matches or [])|map(attribute='name')|list %}
                                {% set is_exact = (torrent.name or torrent.title) in exact_names %}
                                <div class="existing-item {% if is_exact %}exact-match{% endif %}">
                                    {% if is_exact %}<span class="exact-badge">EXACT</span>{% endif %}
                                    {{ torrent.title or torrent.name or 'Unknown' }}
                                    {% if torrent.size %}<span class="size-info">({{ (torrent.size / 1073741824)|round(2) }} GB)</span>{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>No duplicate check yet</p>
                        <button class="btn btn-sm" onclick="checkDuplicates({{ release.id }})">Check Now</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Upload Status (conditional) -->
            {% if release.tracker_statuses %}
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> Upload Status</h3>
                </div>
                <div class="card-body">
                    <div class="upload-list">
                        {% for slug, status_data in release.tracker_statuses.items() %}
                        <div class="upload-item" style="flex-wrap:wrap;gap:0.5rem;">
                            <span class="upload-tracker">{{ slug }}</span>

                            <!-- Hardlink status -->
                            {% if status_data.hardlink_method %}
                            <span style="font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:0.25rem;
                                {% if status_data.hardlink_method == 'hardlink' %}background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3);
                                {% elif status_data.hardlink_method == 'copy' %}background:rgba(251,191,36,0.1);color:#f59e0b;border:1px solid rgba(251,191,36,0.3);
                                {% elif status_data.hardlink_method == 'direct' %}background:rgba(148,163,184,0.1);color:#94a3b8;border:1px solid rgba(148,163,184,0.3);
                                {% elif status_data.hardlink_method == 'failed' %}background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3);
                                {% endif %}"
                                title="{% if status_data.hardlink_method == 'hardlink' %}Hardlink created{% elif status_data.hardlink_method == 'copy' %}File copied (hardlink failed){% elif status_data.hardlink_method == 'direct' %}Using source directly{% elif status_data.hardlink_method == 'failed' %}{{ status_data.hardlink_error or 'Hardlink failed' }}{% endif %}">
                                {% if status_data.hardlink_method == 'hardlink' %}HL
                                {% elif status_data.hardlink_method == 'copy' %}CP
                                {% elif status_data.hardlink_method == 'direct' %}SRC
                                {% elif status_data.hardlink_method == 'failed' %}HL!{% endif %}
                            </span>
                            {% endif %}

                            <!-- Upload status -->
                            <span class="upload-status {{ status_data.status }}">
                                {% if status_data.status == 'success' %}Uploaded
                                {% elif status_data.status == 'failed' %}Failed
                                {% elif status_data.status == 'skipped_duplicate' %}Skipped
                                {% else %}Pending{% endif %}
                            </span>

                            <!-- qBittorrent status -->
                            {% if status_data.qbit_status %}
                            <span style="font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:0.25rem;
                                {% if status_data.qbit_status == 'success' %}background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3);
                                {% elif status_data.qbit_status == 'failed' %}background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3);
                                {% elif status_data.qbit_status == 'manual' %}background:rgba(251,191,36,0.1);color:#f59e0b;border:1px solid rgba(251,191,36,0.3);
                                {% else %}background:rgba(148,163,184,0.1);color:#94a3b8;border:1px solid rgba(148,163,184,0.3);
                                {% endif %}"
                                title="{% if status_data.qbit_status == 'success' %}Injected to qBittorrent{% elif status_data.qbit_status == 'failed' %}qBittorrent injection failed{% elif status_data.qbit_status == 'manual' %}Manual injection required{% else %}qBittorrent not configured{% endif %}">
                                qB:{% if status_data.qbit_status == 'success' %}OK
                                {% elif status_data.qbit_status == 'failed' %}ERR
                                {% elif status_data.qbit_status == 'manual' %}MAN
                                {% else %}N/A{% endif %}
                            </span>
                            {% endif %}

                            {% if status_data.torrent_url %}
                            <a href="{{ status_data.torrent_url }}" target="_blank" class="upload-link">View</a>
                            {% endif %}
                            {% if status_data.status == 'success' and release.torrent_paths.get(slug) %}
                            <button class="btn-qb" onclick="sendToQBittorrent({{ release.id }}, '{{ slug }}')" title="Send to qBittorrent">
                                qB
                            </button>
                            {% endif %}

                            <!-- Torrent file path (small detail) -->
                            {% if release.torrent_paths.get(slug) %}
                            <div style="width:100%;font-size:0.65rem;color:var(--text-muted);font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                {{ release.torrent_paths.get(slug) }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Screenshots (horizontal band, conditional) -->
    {% if release.screenshot_urls %}
    <div class="screenshots-band">
        <div class="screenshots-scroll">
            {% for screenshot in release.screenshot_urls %}
            <a href="{{ screenshot.url }}" target="_blank" class="screenshot-thumb">
                <img src="{{ screenshot.thumb_url or screenshot.url }}" alt="Screenshot">
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- BBCode Preview (collapsible) -->
    <details class="bbcode-details">
        <summary class="bbcode-summary">
            <div class="bbcode-summary-left">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span>BBCode Preview</span>
            </div>
            <div class="bbcode-summary-actions" onclick="event.stopPropagation()">
                <select id="template-selector" class="template-select" title="Selectionner un template">
                    <option value="">Template par defaut</option>
                </select>
                <button class="btn-icon" onclick="toggleBBCodeView()" id="toggle-view-btn" style="display: none;" title="Toggle BBCode/HTML">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                </button>
                <button class="btn-icon" onclick="loadBBCode({{ release.id }})" title="Generate">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
                <button class="btn-icon" onclick="copyBBCode()" id="copy-bbcode-btn" style="display: none;" title="Copy BBCode">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
            </div>
        </summary>
        <div class="bbcode-body">
            <div id="bbcode-container">
                <div class="empty-state small">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    <p>Click generate to create BBCode</p>
                </div>
            </div>
        </div>
    </details>

    <!-- Timeline (horizontal compact) -->
    <div class="timeline-band">
        <div class="timeline-h">
            <div class="timeline-h-item {% if release.created_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Created</span>
                <span class="timeline-h-date">{{ release.created_at.strftime('%d/%m %H:%M') if release.created_at else '-' }}</span>
            </div>
            <div class="timeline-h-line {% if release.scanned_at %}done{% endif %}"></div>
            <div class="timeline-h-item {% if release.scanned_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Scanned</span>
                <span class="timeline-h-date">{{ release.scanned_at.strftime('%d/%m %H:%M') if release.scanned_at else '-' }}</span>
            </div>
            <div class="timeline-h-line {% if release.analyzed_at %}done{% endif %}"></div>
            <div class="timeline-h-item {% if release.analyzed_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Analyzed</span>
                <span class="timeline-h-date">{{ release.analyzed_at.strftime('%d/%m %H:%M') if release.analyzed_at else '-' }}</span>
            </div>
            <div class="timeline-h-line {% if release.renamed_at %}done{% endif %}"></div>
            <div class="timeline-h-item {% if release.renamed_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Renamed</span>
                <span class="timeline-h-date">{{ release.renamed_at.strftime('%d/%m %H:%M') if release.renamed_at else '-' }}</span>
            </div>
            <div class="timeline-h-line {% if release.metadata_generated_at %}done{% endif %}"></div>
            <div class="timeline-h-item {% if release.metadata_generated_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Metadata</span>
                <span class="timeline-h-date">{{ release.metadata_generated_at.strftime('%d/%m %H:%M') if release.metadata_generated_at else '-' }}</span>
            </div>
            <div class="timeline-h-line {% if release.uploaded_at %}done{% endif %}"></div>
            <div class="timeline-h-item {% if release.uploaded_at %}done{% endif %}">
                <div class="timeline-h-dot"></div>
                <span class="timeline-h-label">Uploaded</span>
                <span class="timeline-h-date">{{ release.uploaded_at.strftime('%d/%m %H:%M') if release.uploaded_at else '-' }}</span>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<style>
/* Page Layout */
.release-page {
    max-width: 1400px;
    margin: 0 auto;
}

.error-container {
    text-align: center;
    padding: 4rem 2rem;
}

.error-container .error-icon {
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.error-container h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

/* ─── Hero Section (compact) ─── */
.release-hero {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.hero-backdrop {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(30px) brightness(0.4);
    transform: scale(1.1);
}

.hero-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.7) 100%);
}

.hero-content {
    position: relative;
    padding: 1.25rem 1.5rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-bottom: 1rem;
    transition: color 0.2s;
}

.back-link:hover {
    color: var(--text-primary);
}

.hero-main {
    display: flex;
    gap: 1.25rem;
    align-items: center;
}

.hero-poster {
    width: 100px;
    height: 150px;
    object-fit: cover;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    flex-shrink: 0;
}

.hero-poster-placeholder {
    width: 100px;
    height: 150px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    flex-shrink: 0;
}

.hero-info {
    flex: 1;
    min-width: 0;
}

.hero-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.5rem;
    line-height: 1.2;
}

.hero-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.status-pill {
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
.status-scanned { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
.status-analyzed { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
.status-pending_approval { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
.status-approved { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
.status-renamed { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
.status-metadata_generated { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
.status-uploaded { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
.status-failed { background: rgba(239, 68, 68, 0.2); color: #f87171; }

.tmdb-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.6rem;
    background: rgba(1, 180, 228, 0.2);
    color: #01b4e4;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 500;
}

.info-pill {
    padding: 0.2rem 0.6rem;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 500;
}

/* ─── Pipeline Section ─── */
.pipeline-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.pipeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
}

.pipeline-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.pipeline-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
}

.pipeline-step {
    display: flex;
    align-items: center;
}

.step-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.375rem;
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 80px;
}

.step-button:hover:not(:disabled) {
    border-color: var(--accent-color);
    transform: translateY(-2px);
}

.step-button:disabled {
    cursor: default;
}

.step-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

.step-label {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-muted);
    white-space: nowrap;
}

.step-connector {
    width: 36px;
    height: 2px;
    background: var(--border-color);
}

.pipeline-step:last-child .step-connector {
    display: none;
}

.pipeline-step.completed .step-button {
    border-color: #22c55e;
}

.pipeline-step.completed .step-icon {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.pipeline-step.completed .step-icon .check {
    color: #22c55e;
}

.pipeline-step.completed .step-label {
    color: #22c55e;
}

.pipeline-step.completed .step-connector {
    background: #22c55e;
}

.pipeline-step.current .step-button {
    border-color: var(--accent-color);
    box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.3);
}

.pipeline-step.current .step-icon {
    background: rgba(var(--accent-rgb), 0.2);
    color: var(--accent-color);
}

.pipeline-step.current .step-label {
    color: var(--accent-color);
}

.step-upload .step-icon {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
    color: white;
}

.pipeline-step.completed .step-upload .step-icon {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

/* ─── Content Grid ─── */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* ─── Cards ─── */
.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden;
    margin-bottom: 1rem;
}

.card:last-child {
    margin-bottom: 0;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.card-header h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-header h3 svg {
    color: var(--accent-color);
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.card-body {
    padding: 1.25rem;
}

/* ─── Release Info (merged file + mediainfo) ─── */
.release-info-grid {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.info-section {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.info-row.full {
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    flex-shrink: 0;
}

.info-value {
    color: var(--text-primary);
    font-size: 0.875rem;
    text-align: right;
    word-break: break-all;
}

.info-value.mono {
    font-family: 'Consolas', 'Monaco', monospace;
}

.info-value.small {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: left;
}

.specs-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.spec-col {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.spec-title {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--accent-color);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.spec-grid {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.spec-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

.spec-item.highlight .spec-value {
    color: #22c55e;
}

.spec-label {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.spec-value {
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 500;
}

.tracker-names-section {
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.empty-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: rgba(var(--accent-rgb), 0.08);
    border: 1px dashed rgba(var(--accent-rgb), 0.3);
    border-radius: 0.5rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

.empty-hint svg {
    color: var(--accent-color);
    flex-shrink: 0;
}

/* ─── Empty State ─── */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-muted);
    text-align: center;
}

.empty-state.small {
    padding: 1.5rem;
}

.empty-state svg {
    margin-bottom: 0.75rem;
    opacity: 0.5;
}

.empty-state p {
    font-size: 0.875rem;
}

.empty-state .btn {
    margin-top: 1rem;
}

/* ─── Duplicate Check ─── */
.dup-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    font-weight: 500;
}

.dup-status.success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.dup-status.warning {
    background: rgba(251, 146, 60, 0.1);
    color: #fb923c;
}

.tracker-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tracker-item {
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
    padding: 0.625rem 0.75rem;
    border-left: 3px solid var(--border-color);
}

.tracker-item.has-dup {
    border-left-color: #fb923c;
}

.tracker-item.has-exact-match {
    border-left-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.tracker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracker-name {
    font-weight: 500;
    font-size: 0.85rem;
}

.dup-count {
    background: rgba(251, 146, 60, 0.2);
    color: #fb923c;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
}

.dup-exact {
    background: rgba(239, 68, 68, 0.3);
    color: #ef4444;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 700;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.dup-clear {
    color: #22c55e;
    font-size: 0.7rem;
}

.dup-error {
    color: #ef4444;
    font-size: 0.7rem;
}

.existing-list {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.existing-item {
    font-size: 0.7rem;
    color: var(--text-muted);
    padding: 0.25rem 0;
    font-family: monospace;
    word-break: break-all;
}

.existing-item.exact-match {
    color: #ef4444;
    font-weight: 600;
    background: rgba(239, 68, 68, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin: 0.25rem 0;
}

.exact-badge {
    background: #ef4444;
    color: white;
    padding: 0.1rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.6rem;
    font-weight: 700;
    margin-right: 0.5rem;
    font-family: sans-serif;
}

.size-info {
    color: var(--text-muted);
    font-size: 0.6rem;
    margin-left: 0.5rem;
    opacity: 0.8;
}

/* ─── Upload Status ─── */
.upload-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.upload-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
}

.upload-tracker {
    font-weight: 500;
    font-size: 0.85rem;
    flex: 1;
}

.upload-status {
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
}

.upload-status.success {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.upload-status.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.upload-status.skipped_duplicate {
    background: rgba(251, 146, 60, 0.2);
    color: #fb923c;
}

.upload-link {
    font-size: 0.75rem;
    color: var(--accent-color);
}

.btn-qb {
    padding: 0.2rem 0.5rem;
    font-size: 0.65rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-qb:hover {
    background: rgba(59, 130, 246, 0.3);
    border-color: #60a5fa;
}

.btn-qb:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-qb.loading {
    opacity: 0.7;
    pointer-events: none;
}

/* ─── Screenshots (horizontal band) ─── */
.screenshots-band {
    margin-bottom: 1.5rem;
    overflow: hidden;
    border-radius: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    padding: 0.75rem;
}

.screenshots-scroll {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.25rem;
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) transparent;
}

.screenshots-scroll::-webkit-scrollbar {
    height: 4px;
}

.screenshots-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.screenshots-scroll::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 2px;
}

.screenshot-thumb {
    flex-shrink: 0;
    height: 80px;
    border-radius: 0.375rem;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.screenshot-thumb:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.screenshot-thumb img {
    height: 100%;
    width: auto;
    display: block;
}

/* ─── BBCode (collapsible) ─── */
.bbcode-details {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.bbcode-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1.25rem;
    background: var(--bg-tertiary);
    cursor: pointer;
    user-select: none;
    list-style: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.bbcode-details[open] .bbcode-summary {
    border-bottom-color: var(--border-color);
}

.bbcode-summary::-webkit-details-marker {
    display: none;
}

.bbcode-summary::marker {
    display: none;
    content: '';
}

.bbcode-summary-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.bbcode-summary-left svg {
    color: var(--accent-color);
}

.bbcode-summary-left::before {
    content: '';
    display: inline-block;
    width: 0;
    height: 0;
    border-left: 5px solid var(--text-muted);
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    transition: transform 0.2s;
    margin-right: 0.25rem;
}

.bbcode-details[open] .bbcode-summary-left::before {
    transform: rotate(90deg);
}

.bbcode-summary-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.bbcode-body {
    padding: 1.25rem;
}

#bbcode-container {
    display: flex;
    flex-direction: column;
    min-height: 300px;
}

#bbcode-content {
    width: 100%;
    flex: 1;
    min-height: 400px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.75rem;
    color: var(--text-primary);
    resize: none;
    white-space: pre-wrap;
    word-wrap: break-word;
}

#bbcode-html-preview {
    width: 100%;
    flex: 1;
    min-height: 400px;
}

#bbcode-html-preview img {
    display: block;
    margin: 0.5rem auto;
    max-width: 100%;
    height: auto;
    border-radius: 0.25rem;
}

#bbcode-html-preview strong {
    font-weight: 600;
    color: var(--text-primary);
}

#bbcode-html-preview blockquote {
    font-style: italic;
}

#bbcode-html-preview a {
    transition: opacity 0.2s;
}

#bbcode-html-preview a:hover {
    opacity: 0.8;
}

/* Template Selector */
.template-select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 0.375rem 0.75rem;
    color: var(--text-primary);
    font-size: 0.75rem;
    cursor: pointer;
    min-width: 150px;
    transition: border-color 0.2s;
}

.template-select:hover,
.template-select:focus {
    border-color: var(--accent-color);
    outline: none;
}

/* ─── Timeline (horizontal compact) ─── */
.timeline-band {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
}

.timeline-h {
    display: flex;
    align-items: flex-start;
    min-width: max-content;
}

.timeline-h-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    min-width: 80px;
}

.timeline-h-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--border-color);
    flex-shrink: 0;
}

.timeline-h-item.done .timeline-h-dot {
    background: #22c55e;
    box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
}

.timeline-h-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-weight: 500;
}

.timeline-h-item.done .timeline-h-label {
    color: var(--text-primary);
}

.timeline-h-date {
    font-size: 0.65rem;
    color: var(--text-muted);
    font-family: monospace;
}

.timeline-h-line {
    width: 40px;
    height: 2px;
    background: var(--border-color);
    margin-top: 5px;
    flex-shrink: 0;
}

.timeline-h-line.done {
    background: #22c55e;
}

/* ─── Alerts ─── */
.alert {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.5rem;
    font-size: 0.85rem;
}

.alert-success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.alert-warning {
    background: rgba(251, 146, 60, 0.1);
    color: #fb923c;
}

/* ─── Buttons ─── */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.btn:hover {
    border-color: var(--accent-color);
}

.btn-primary {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-hover);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}

/* ─── Loading animation ─── */
.step-button.loading .step-icon svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ─── Tracker release names ─── */
.tracker-names-list {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    width: 100%;
    margin-top: 0.5rem;
}

.tracker-name-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.375rem 0.625rem;
    background: var(--bg-tertiary, #1e293b);
    border-radius: 0.375rem;
    border-left: 3px solid var(--accent-primary, #3b82f6);
}

.tracker-slug {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--accent-primary, #3b82f6);
    min-width: 50px;
}

.tracker-name {
    font-size: 0.8rem;
    color: var(--text-secondary, #94a3b8);
    word-break: break-all;
}

.preview-badge {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--warning, #f59e0b);
    opacity: 0.8;
    vertical-align: middle;
}

.tracker-name-editable {
    flex: 1;
    min-width: 0;
}

.tracker-name-input {
    width: 100%;
    background: var(--bg-primary, #0f172a);
    border: 1px solid var(--accent-primary, #3b82f6);
    border-radius: 0.25rem;
    color: var(--text-primary, #e2e8f0);
    font-size: 0.8rem;
    padding: 0.1rem 0.4rem;
    outline: none;
}

.edit-btn {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--text-muted, #475569);
    cursor: pointer;
    padding: 0.1rem 0.25rem;
    border-radius: 0.2rem;
    opacity: 0.5;
    transition: opacity 0.15s;
}
.edit-btn:hover { opacity: 1; color: var(--accent-primary, #3b82f6); }

.tracker-name span[id^="tracker-name-display-"] { cursor: pointer; }
.tracker-name span[id^="tracker-name-display-"]:hover { color: var(--text-primary, #e2e8f0); }

/* ─── Responsive ─── */
@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }

    .hero-main {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .hero-pills {
        justify-content: center;
    }

    .pipeline-steps {
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .step-connector {
        display: none;
    }

    .specs-columns {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
async function checkDuplicates(releaseId) {
    const container = document.getElementById('duplicate-results-container');
    container.innerHTML = '<div class="empty-state"><div class="loading loading-spinner loading-lg"></div><p>Checking...</p></div>';

    try {
        const response = await fetch(`/api/releases/${releaseId}/check-duplicates`, { method: 'POST' });
        const result = await response.json();
        if (result.status === 'success') {
            window.location.reload();
        } else {
            container.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

async function executeStep(releaseId, stepName) {
    const resultDiv = document.getElementById('action-result');
    const button = event.currentTarget;

    button.classList.add('loading');
    resultDiv.innerHTML = '';

    try {
        const response = await fetch(`/api/releases/${releaseId}/step/${stepName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();

        if (result.status === 'success') {
            resultDiv.innerHTML = `<div class="alert alert-success"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${result.message}</div>`;
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">${result.message || 'Failed'}</div>`;
            button.classList.remove('loading');
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        button.classList.remove('loading');
    }
}

async function sendToQBittorrent(releaseId, trackerSlug) {
    const button = event.currentTarget;
    const resultDiv = document.getElementById('action-result');
    const originalText = button.textContent;

    button.classList.add('loading');
    button.textContent = '...';

    try {
        const response = await fetch(`/api/releases/${releaseId}/send-to-qbittorrent/${trackerSlug}`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.status === 'success') {
            button.textContent = '\u2713';
            button.style.background = 'rgba(34, 197, 94, 0.2)';
            button.style.color = '#22c55e';
            button.style.borderColor = '#22c55e';
            resultDiv.innerHTML = `<div class="alert alert-success"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${result.message}</div>`;
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('loading');
                button.style.background = '';
                button.style.color = '';
                button.style.borderColor = '';
            }, 3000);
        } else {
            button.textContent = originalText;
            button.classList.remove('loading');
            resultDiv.innerHTML = `<div class="alert alert-error">${result.message || 'Failed to send to qBittorrent'}</div>`;
        }
    } catch (error) {
        button.textContent = originalText;
        button.classList.remove('loading');
        resultDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

// BBCode to HTML converter
function bbcodeToHtml(bbcode) {
    let html = bbcode;

    html = html.replace(/\[center\]([\s\S]*?)\[\/center\]/gi, '<div style="text-align: center;">$1</div>');
    html = html.replace(/\[img\](.*?)\[\/img\]/gi, '<img src="$1" style="max-width: 100%; height: auto;" />');
    html = html.replace(/\[h1\]([\s\S]*?)\[\/h1\]/gi, '<h1 style="font-size:1.8em;margin:0.5em 0;">$1</h1>');
    html = html.replace(/\[h2\]([\s\S]*?)\[\/h2\]/gi, '<h2 style="font-size:1.4em;margin:0.5em 0;">$1</h2>');
    html = html.replace(/\[h3\]([\s\S]*?)\[\/h3\]/gi, '<h3 style="font-size:1.2em;margin:0.4em 0;">$1</h3>');
    html = html.replace(/\[size=(\d+)\]([\s\S]*?)\[\/size\]/gi, (m, size, text) => {
        const px = parseInt(size) * 4 + 8;
        return `<span style="font-size:${px}px;">${text}</span>`;
    });
    html = html.replace(/\[color=(#?[\w]+)\]([\s\S]*?)\[\/color\]/gi, '<span style="color: $1;">$2</span>');
    html = html.replace(/\[b\]([\s\S]*?)\[\/b\]/gi, '<strong>$1</strong>');
    html = html.replace(/\[i\]([\s\S]*?)\[\/i\]/gi, '<em>$1</em>');
    html = html.replace(/\[u\]([\s\S]*?)\[\/u\]/gi, '<u>$1</u>');
    html = html.replace(/\[quote\]([\s\S]*?)\[\/quote\]/gi, '<blockquote style="border-left: 3px solid #4a5568; padding-left: 1rem; margin: 1rem 0; color: #a0aec0;">$1</blockquote>');
    html = html.replace(/\[table\]([\s\S]*?)\[\/table\]/gi, '<table style="border-collapse:collapse;margin:0.5em auto;width:auto;">$1</table>');
    html = html.replace(/\[tr\]([\s\S]*?)\[\/tr\]/gi, '<tr>$1</tr>');
    html = html.replace(/\[td\]([\s\S]*?)\[\/td\]/gi, '<td style="padding:4px 12px;border:1px solid #4a5568;">$1</td>');
    html = html.replace(/\[url=(.*?)\]([\s\S]*?)\[\/url\]/gi, '<a href="$1" style="color: #60a5fa; text-decoration: underline;">$2</a>');
    html = html.replace(/\[url\](.*?)\[\/url\]/gi, '<a href="$1" style="color: #60a5fa; text-decoration: underline;">$1</a>');
    html = html.replace(/\n/g, '<br>');

    return html;
}

let bbcodeViewMode = 'bbcode';
let currentBBCodeContent = '';
let templatesLoaded = false;

async function loadTemplates() {
    if (templatesLoaded) return;

    try {
        const response = await fetch('/api/templates');
        const result = await response.json();

        if (result.status === 'success' && result.templates) {
            const selector = document.getElementById('template-selector');
            selector.innerHTML = '<option value="">Template par defaut</option>';

            result.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                if (template.is_default) {
                    option.textContent += ' (defaut)';
                }
                selector.appendChild(option);
            });

            templatesLoaded = true;
        }
    } catch (error) {
        console.error('Failed to load templates:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadTemplates);

async function loadBBCode(releaseId) {
    const container = document.getElementById('bbcode-container');
    const copyBtn = document.getElementById('copy-bbcode-btn');
    const toggleBtn = document.getElementById('toggle-view-btn');
    const templateSelector = document.getElementById('template-selector');
    const selectedTemplateId = templateSelector ? templateSelector.value : '';

    container.innerHTML = '<div class="empty-state small"><div class="loading loading-spinner"></div><p>Generating...</p></div>';
    copyBtn.style.display = 'none';
    toggleBtn.style.display = 'none';

    try {
        let url = `/api/releases/${releaseId}/bbcode`;
        if (selectedTemplateId) {
            url += `?template_id=${selectedTemplateId}`;
        }

        const response = await fetch(url);
        const result = await response.json();

        if (result.status === 'success' && result.bbcode) {
            currentBBCodeContent = result.bbcode;
            bbcodeViewMode = 'bbcode';

            const escaped = result.bbcode.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            container.innerHTML = `<textarea id="bbcode-content" readonly>${escaped}</textarea>`;
            copyBtn.style.display = 'flex';
            toggleBtn.style.display = 'flex';
        } else {
            container.innerHTML = `<div class="alert alert-warning">${result.message || 'Could not generate BBCode'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

function toggleBBCodeView() {
    const container = document.getElementById('bbcode-container');
    const toggleBtn = document.getElementById('toggle-view-btn');

    if (!currentBBCodeContent) return;

    if (bbcodeViewMode === 'bbcode') {
        bbcodeViewMode = 'html';
        const html = bbcodeToHtml(currentBBCodeContent);
        container.innerHTML = `<div id="bbcode-html-preview" style="padding: 1rem; background: #1a202c; border-radius: 0.5rem; overflow-x: auto; font-family: 'Segoe UI', sans-serif; line-height: 1.6;">${html}</div>`;
        toggleBtn.title = 'Show BBCode';
    } else {
        bbcodeViewMode = 'bbcode';
        const escaped = currentBBCodeContent.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        container.innerHTML = `<textarea id="bbcode-content" readonly>${escaped}</textarea>`;
        toggleBtn.title = 'Show HTML Preview';
    }
}

async function copyBBCode() {
    const textarea = document.getElementById('bbcode-content');
    const copyBtn = document.getElementById('copy-bbcode-btn');
    if (!textarea) return;

    try {
        await navigator.clipboard.writeText(textarea.value);
        copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
        setTimeout(() => {
            copyBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
        }, 2000);
    } catch (e) {
        textarea.select();
        document.execCommand('copy');
    }
}

// ── Tracker name inline edit ──────────────────────────────────────────────
function startEditTrackerName(slug, trackerName, displayEl) {
    const input = document.getElementById('tracker-name-input-' + slug);
    const display = document.getElementById('tracker-name-display-' + slug);
    display.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
}

function cancelEditTrackerName(slug) {
    const input = document.getElementById('tracker-name-input-' + slug);
    const display = document.getElementById('tracker-name-display-' + slug);
    // Small delay so click-save fires before blur-cancel
    setTimeout(() => {
        input.style.display = 'none';
        display.style.display = '';
    }, 150);
}

function handleTrackerNameKey(event, releaseId, slug) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveTrackerName(releaseId, slug);
    } else if (event.key === 'Escape') {
        cancelEditTrackerName(slug);
    }
}

async function saveTrackerName(releaseId, slug) {
    const input = document.getElementById('tracker-name-input-' + slug);
    const display = document.getElementById('tracker-name-display-' + slug);
    const newName = input.value.trim();
    if (!newName) return;

    try {
        const resp = await fetch(`/api/releases/${releaseId}/tracker-name`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tracker_slug: slug, release_name: newName }),
        });
        if (!resp.ok) throw new Error(await resp.text());

        // Update display (strip preview badge if present)
        display.textContent = newName;
        input.style.display = 'none';
        display.style.display = '';
    } catch (e) {
        console.error('Failed to save tracker name:', e);
        input.style.border = '1px solid #ef4444';
    }
}
</script>
{% endblock %}
