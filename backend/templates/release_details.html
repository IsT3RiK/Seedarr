{% extends "base.html" %}

{% block title %}{{ release.display_name if release else 'Release Details' }} - Seedarr{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
<div class="release-page">
    {% if error %}
    <div class="error-container">
        <div class="error-icon">
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2>Release Not Found</h2>
        <p class="text-muted">{{ error }}</p>
        <a href="/queue" class="btn btn-primary mt-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Queue
        </a>
    </div>
    {% elif release %}

    <!-- Hero Header with Backdrop -->
    <div class="release-hero">
        {% if release.cover_url %}
        <div class="hero-backdrop" style="background-image: url('{{ release.cover_url }}')"></div>
        {% endif %}
        <div class="hero-gradient"></div>

        <div class="hero-content">
            <a href="/queue" class="back-link">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Queue
            </a>

            <div class="hero-main">
                {% if release.cover_url %}
                <img src="{{ release.cover_url }}" alt="Cover" class="hero-poster">
                {% else %}
                <div class="hero-poster-placeholder">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                    </svg>
                </div>
                {% endif %}

                <div class="hero-info">
                    <div class="hero-badges">
                        <span class="status-pill status-{{ release.status.value }}">{{ release.status_display }}</span>
                        {% if release.tmdb_id %}
                        <span class="tmdb-badge">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            TMDB {{ release.tmdb_id }}
                        </span>
                        {% endif %}
                    </div>

                    <h1 class="hero-title">{{ release.display_name }}</h1>

                    {% if release.description %}
                    <p class="hero-description">{{ release.description[:200] }}{% if release.description|length > 200 %}...{% endif %}</p>
                    {% endif %}

                    <div class="hero-meta">
                        <div class="meta-item">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7C5 4 4 5 4 7z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6"></path>
                            </svg>
                            <span>{{ release.file_size_display }}</span>
                        </div>
                        {% if release.mediainfo_raw and release.mediainfo.video %}
                        <div class="meta-item">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <span>{{ release.mediainfo.video.resolution }} {{ release.mediainfo.video.codec }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>{{ release.progress }}% Complete</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Steps -->
    <div class="pipeline-section">
        <div class="pipeline-header">
            <h2>Processing Pipeline</h2>
            <div id="action-result"></div>
        </div>
        <div class="pipeline-steps">
            <div class="pipeline-step {% if release.scanned_at %}completed{% elif not release.scanned_at and not release.analyzed_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'scan')" {% if release.scanned_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.scanned_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Scan</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <div class="pipeline-step {% if release.analyzed_at %}completed{% elif release.scanned_at and not release.analyzed_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'analyze')" {% if release.analyzed_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.analyzed_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Analyze</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <div class="pipeline-step {% if release.renamed_at %}completed{% elif release.analyzed_at and not release.renamed_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'rename')" {% if release.renamed_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.renamed_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Rename</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <div class="pipeline-step {% if release.metadata_generated_at %}completed{% elif release.renamed_at and not release.metadata_generated_at %}current{% endif %}">
                <button class="step-button" onclick="executeStep({{ release.id }}, 'metadata')" {% if release.metadata_generated_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.metadata_generated_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Metadata</span>
                </button>
                <div class="step-connector"></div>
            </div>

            <div class="pipeline-step {% if release.uploaded_at %}completed{% elif release.metadata_generated_at and not release.uploaded_at %}current{% endif %}">
                <button class="step-button step-upload" onclick="executeStep({{ release.id }}, 'upload')" {% if release.uploaded_at %}disabled{% endif %}>
                    <div class="step-icon">
                        {% if release.uploaded_at %}
                        <svg class="w-5 h-5 check" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="step-label">Upload</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Left Column -->
        <div class="content-left">
            <!-- File Information -->
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> File Information</h3>
                </div>
                <div class="card-body">
                    <div class="info-list">
                        <div class="info-row">
                            <span class="info-label">Filename</span>
                            <span class="info-value mono">{{ release.filename }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Size</span>
                            <span class="info-value">{{ release.file_size_display }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Release Name</span>
                            <span class="info-value mono">{{ release.final_release_name or release.release_name or 'Not set' }}</span>
                        </div>
                        {% if release.tracker_release_names %}
                        <div class="info-row full">
                            <span class="info-label">Noms par Tracker</span>
                            <div class="tracker-names-list">
                                {% for tracker_slug, tracker_name in release.tracker_release_names.items() %}
                                <div class="tracker-name-item">
                                    <span class="tracker-slug">{{ tracker_slug }}</span>
                                    <span class="tracker-name mono">{{ tracker_name }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="info-row full">
                            <span class="info-label">Path</span>
                            <span class="info-value mono small">{{ release.file_path }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MediaInfo -->
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> MediaInfo</h3>
                </div>
                <div class="card-body">
                    {% if release.mediainfo_raw %}
                    <div class="media-specs">
                        <div class="spec-group">
                            <div class="spec-title">Video</div>
                            <div class="spec-grid">
                                <div class="spec-item">
                                    <span class="spec-label">Resolution</span>
                                    <span class="spec-value">{{ release.mediainfo.video.resolution }}</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Codec</span>
                                    <span class="spec-value">{{ release.mediainfo.video.codec }}</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">FPS</span>
                                    <span class="spec-value">{{ release.mediainfo.video.frame_rate }}</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Bit Depth</span>
                                    <span class="spec-value">{{ release.mediainfo.video.bit_depth }}-bit</span>
                                </div>
                                {% if release.mediainfo.video.hdr %}
                                <div class="spec-item highlight">
                                    <span class="spec-label">HDR</span>
                                    <span class="spec-value">Yes</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="spec-group">
                            <div class="spec-title">Audio</div>
                            <div class="spec-grid">
                                <div class="spec-item">
                                    <span class="spec-label">Codec</span>
                                    <span class="spec-value">{{ release.mediainfo.audio.codec }}</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Channels</span>
                                    <span class="spec-value">{{ release.mediainfo.audio.channels }}</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Language</span>
                                    <span class="spec-value">{{ release.mediainfo.audio.language }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="spec-group">
                            <div class="spec-title">General</div>
                            <div class="spec-grid">
                                <div class="spec-item">
                                    <span class="spec-label">Duration</span>
                                    <span class="spec-value">{{ release.mediainfo.duration_display }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>Run Analyze step to get MediaInfo</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="content-right">
            <!-- Duplicate Check -->
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Duplicate Check</h3>
                    <button class="btn-icon" onclick="checkDuplicates({{ release.id }})" title="Refresh">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div class="card-body" id="duplicate-results-container">
                    {% if release.duplicate_check_results %}
                    <div class="dup-status {% if release.duplicate_check_results.has_duplicates %}warning{% else %}success{% endif %}">
                        {% if release.duplicate_check_results.has_duplicates %}
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Duplicates found</span>
                        {% else %}
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>No duplicates found</span>
                        {% endif %}
                    </div>

                    <div class="tracker-list">
                        {% for slug, data in release.duplicate_check_results.results.items() %}
                        <div class="tracker-item {% if data.exact_match %}has-exact-match{% elif data.is_duplicate %}has-dup{% endif %}">
                            <div class="tracker-header">
                                <span class="tracker-name">{{ data.tracker_name or slug }}</span>
                                {% if data.exact_match %}
                                <span class="dup-exact" title="Exact same file size - likely same release!">EXACT {{ data.exact_matches|length if data.exact_matches else 1 }}</span>
                                {% elif data.is_duplicate %}
                                <span class="dup-count">{{ data.existing_torrents|length if data.existing_torrents else 0 }}</span>
                                {% elif data.error %}
                                <span class="dup-error">Error</span>
                                {% else %}
                                <span class="dup-clear">Clear</span>
                                {% endif %}
                            </div>
                            {% if data.is_duplicate and data.existing_torrents %}
                            <div class="existing-list">
                                {% for torrent in data.existing_torrents %}
                                {% set exact_names = (data.exact_matches or [])|map(attribute='name')|list %}
                                {% set is_exact = (torrent.name or torrent.title) in exact_names %}
                                <div class="existing-item {% if is_exact %}exact-match{% endif %}">
                                    {% if is_exact %}<span class="exact-badge">EXACT</span>{% endif %}
                                    {{ torrent.title or torrent.name or 'Unknown' }}
                                    {% if torrent.size %}<span class="size-info">({{ (torrent.size / 1073741824)|round(2) }} GB)</span>{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>No duplicate check yet</p>
                        <button class="btn btn-sm" onclick="checkDuplicates({{ release.id }})">Check Now</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Upload Status -->
            {% if release.tracker_statuses %}
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> Upload Status</h3>
                </div>
                <div class="card-body">
                    <div class="upload-list">
                        {% for slug, status_data in release.tracker_statuses.items() %}
                        <div class="upload-item">
                            <span class="upload-tracker">{{ slug }}</span>
                            <span class="upload-status {{ status_data.status }}">
                                {% if status_data.status == 'success' %}Uploaded
                                {% elif status_data.status == 'failed' %}Failed
                                {% elif status_data.status == 'skipped_duplicate' %}Skipped
                                {% else %}Pending{% endif %}
                            </span>
                            {% if status_data.torrent_url %}
                            <a href="{{ status_data.torrent_url }}" target="_blank" class="upload-link">View</a>
                            {% endif %}
                            {% if status_data.status == 'success' and release.torrent_paths.get(slug) %}
                            <button class="btn-qb" onclick="sendToQBittorrent({{ release.id }}, '{{ slug }}')" title="Send to qBittorrent">
                                qB
                            </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Screenshots -->
            {% if release.screenshot_urls %}
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Screenshots</h3>
                </div>
                <div class="card-body">
                    <div class="screenshot-grid">
                        {% for screenshot in release.screenshot_urls %}
                        <a href="{{ screenshot.url }}" target="_blank" class="screenshot-item">
                            <img src="{{ screenshot.thumb_url or screenshot.url }}" alt="Screenshot">
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Timeline</h3>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item {% if release.created_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Created</span>
                                <span class="timeline-date">{{ release.created_at.strftime('%d/%m %H:%M') if release.created_at else '-' }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if release.scanned_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Scanned</span>
                                <span class="timeline-date">{{ release.scanned_at.strftime('%d/%m %H:%M') if release.scanned_at else '-' }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if release.analyzed_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Analyzed</span>
                                <span class="timeline-date">{{ release.analyzed_at.strftime('%d/%m %H:%M') if release.analyzed_at else '-' }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if release.renamed_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Renamed</span>
                                <span class="timeline-date">{{ release.renamed_at.strftime('%d/%m %H:%M') if release.renamed_at else '-' }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if release.metadata_generated_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Metadata</span>
                                <span class="timeline-date">{{ release.metadata_generated_at.strftime('%d/%m %H:%M') if release.metadata_generated_at else '-' }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if release.uploaded_at %}done{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-label">Uploaded</span>
                                <span class="timeline-date">{{ release.uploaded_at.strftime('%d/%m %H:%M') if release.uploaded_at else '-' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BBCode Preview - Full Width (2 columns) -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg> BBCode Preview</h3>
                <div class="header-actions">
                    <select id="template-selector" class="template-select" title="Selectionner un template">
                        <option value="">Template par defaut</option>
                    </select>
                    <button class="btn-icon" onclick="toggleBBCodeView()" id="toggle-view-btn" style="display: none;" title="Toggle BBCode/HTML">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                    <button class="btn-icon" onclick="loadBBCode({{ release.id }})" title="Generate">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <button class="btn-icon" onclick="copyBBCode()" id="copy-bbcode-btn" style="display: none;" title="Copy BBCode">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="bbcode-container">
                    <div class="empty-state small">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        <p>Click generate to create BBCode</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<style>
/* Page Layout */
.release-page {
    max-width: 1400px;
    margin: 0 auto;
}

.error-container {
    text-align: center;
    padding: 4rem 2rem;
}

.error-container .error-icon {
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.error-container h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

/* Hero Section */
.release-hero {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 1.5rem;
    min-height: 280px;
}

.hero-backdrop {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(30px) brightness(0.4);
    transform: scale(1.1);
}

.hero-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.7) 100%);
}

.hero-content {
    position: relative;
    padding: 1.5rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
    transition: color 0.2s;
}

.back-link:hover {
    color: var(--text-primary);
}

.hero-main {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.hero-poster {
    width: 140px;
    height: 210px;
    object-fit: cover;
    border-radius: 0.75rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    flex-shrink: 0;
}

.hero-poster-placeholder {
    width: 140px;
    height: 210px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    flex-shrink: 0;
}

.hero-info {
    flex: 1;
    min-width: 0;
}

.hero-badges {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.status-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
.status-scanned { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
.status-analyzed { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
.status-pending_approval { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
.status-approved { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
.status-renamed { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
.status-metadata_generated { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
.status-uploaded { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
.status-failed { background: rgba(239, 68, 68, 0.2); color: #f87171; }

.tmdb-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: rgba(1, 180, 228, 0.2);
    color: #01b4e4;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.hero-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.5rem;
    line-height: 1.2;
}

.hero-description {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 1rem;
}

.hero-meta {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
}

.meta-item svg {
    color: var(--accent-color);
}

/* Pipeline Section */
.pipeline-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.pipeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.pipeline-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.pipeline-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
}

.pipeline-step {
    display: flex;
    align-items: center;
}

.step-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 90px;
}

.step-button:hover:not(:disabled) {
    border-color: var(--accent-color);
    transform: translateY(-2px);
}

.step-button:disabled {
    cursor: default;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

.step-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-muted);
}

.step-connector {
    width: 40px;
    height: 2px;
    background: var(--border-color);
}

.pipeline-step:last-child .step-connector {
    display: none;
}

.pipeline-step.completed .step-button {
    border-color: #22c55e;
}

.pipeline-step.completed .step-icon {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.pipeline-step.completed .step-icon .check {
    color: #22c55e;
}

.pipeline-step.completed .step-label {
    color: #22c55e;
}

.pipeline-step.completed .step-connector {
    background: #22c55e;
}

.pipeline-step.current .step-button {
    border-color: var(--accent-color);
    box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3);
}

.pipeline-step.current .step-icon {
    background: rgba(var(--accent-rgb), 0.2);
    color: var(--accent-color);
}

.pipeline-step.current .step-label {
    color: var(--accent-color);
}

.step-upload .step-icon {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
    color: white;
}

.pipeline-step.completed .step-upload .step-icon {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

/* Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }

    .hero-main {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .hero-meta {
        justify-content: center;
    }

    .pipeline-steps {
        flex-wrap: wrap;
    }

    .step-connector {
        display: none;
    }
}

/* Cards */
.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden;
    margin-bottom: 1rem;
}

.card:last-child {
    margin-bottom: 0;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.card-header h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-header h3 svg {
    color: var(--accent-color);
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.card-body {
    padding: 1.25rem;
}

/* BBCode container - full height */
#bbcode-container {
    display: flex;
    flex-direction: column;
    min-height: 600px;
}

/* Info List */
.info-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.info-row.full {
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    flex-shrink: 0;
}

.info-value {
    color: var(--text-primary);
    font-size: 0.875rem;
    text-align: right;
    word-break: break-all;
}

.info-value.mono {
    font-family: 'Consolas', 'Monaco', monospace;
}

.info-value.small {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: left;
}

/* Media Specs */
.media-specs {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.spec-group {
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.spec-group:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.spec-title {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--accent-color);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
}

.spec-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
}

.spec-item {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
}

.spec-item.highlight .spec-value {
    color: #22c55e;
}

.spec-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

.spec-value {
    font-size: 0.875rem;
    color: var(--text-primary);
    font-weight: 500;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-muted);
    text-align: center;
}

.empty-state.small {
    padding: 1.5rem;
}

.empty-state svg {
    margin-bottom: 0.75rem;
    opacity: 0.5;
}

.empty-state p {
    font-size: 0.875rem;
}

.empty-state .btn {
    margin-top: 1rem;
}

/* Duplicate Check */
.dup-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.dup-status.success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.dup-status.warning {
    background: rgba(251, 146, 60, 0.1);
    color: #fb923c;
}

.tracker-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tracker-item {
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
    padding: 0.75rem;
    border-left: 3px solid var(--border-color);
}

.tracker-item.has-dup {
    border-left-color: #fb923c;
}

.tracker-item.has-exact-match {
    border-left-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.tracker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracker-name {
    font-weight: 500;
    font-size: 0.875rem;
}

.dup-count {
    background: rgba(251, 146, 60, 0.2);
    color: #fb923c;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.dup-exact {
    background: rgba(239, 68, 68, 0.3);
    color: #ef4444;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 700;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.dup-clear {
    color: #22c55e;
    font-size: 0.75rem;
}

.dup-error {
    color: #ef4444;
    font-size: 0.75rem;
}

.existing-list {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.existing-item {
    font-size: 0.75rem;
    color: var(--text-muted);
    padding: 0.25rem 0;
    font-family: monospace;
    word-break: break-all;
}

.existing-item.exact-match {
    color: #ef4444;
    font-weight: 600;
    background: rgba(239, 68, 68, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin: 0.25rem 0;
}

.exact-badge {
    background: #ef4444;
    color: white;
    padding: 0.1rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.65rem;
    font-weight: 700;
    margin-right: 0.5rem;
    font-family: sans-serif;
}

.size-info {
    color: var(--text-muted);
    font-size: 0.65rem;
    margin-left: 0.5rem;
    opacity: 0.8;
}

/* Upload Status */
.upload-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.upload-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
}

.upload-tracker {
    font-weight: 500;
    font-size: 0.875rem;
    flex: 1;
}

.upload-status {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
}

.upload-status.success {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.upload-status.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.upload-status.skipped_duplicate {
    background: rgba(251, 146, 60, 0.2);
    color: #fb923c;
}

.upload-link {
    font-size: 0.75rem;
    color: var(--accent-color);
}

.btn-qb {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-qb:hover {
    background: rgba(59, 130, 246, 0.3);
    border-color: #60a5fa;
}

.btn-qb:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-qb.loading {
    opacity: 0.7;
    pointer-events: none;
}

/* Screenshots */
.screenshot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5rem;
}

.screenshot-item {
    border-radius: 0.5rem;
    overflow: hidden;
    transition: transform 0.2s;
}

.screenshot-item:hover {
    transform: scale(1.02);
}

.screenshot-item img {
    width: 100%;
    height: auto;
    display: block;
}

/* Timeline */
.timeline {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.timeline-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 0;
    position: relative;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 7px;
    top: 28px;
    bottom: -8px;
    width: 2px;
    background: var(--border-color);
}

.timeline-item.done:not(:last-child)::after {
    background: #22c55e;
}

.timeline-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--border-color);
    flex-shrink: 0;
}

.timeline-item.done .timeline-dot {
    background: #22c55e;
}

.timeline-content {
    display: flex;
    justify-content: space-between;
    flex: 1;
}

.timeline-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.timeline-item.done .timeline-label {
    color: var(--text-primary);
}

.timeline-date {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: monospace;
}

/* BBCode */
#bbcode-content {
    width: 100%;
    flex: 1;
    min-height: 600px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.75rem;
    color: var(--text-primary);
    resize: none;
    white-space: pre-wrap;
    word-wrap: break-word;
}

#bbcode-html-preview {
    width: 100%;
    flex: 1;
    min-height: 600px;
}

#bbcode-html-preview img {
    display: block;
    margin: 0.5rem auto;
    max-width: 100%;
    height: auto;
    border-radius: 0.25rem;
}

#bbcode-html-preview strong {
    font-weight: 600;
    color: var(--text-primary);
}

#bbcode-html-preview blockquote {
    font-style: italic;
}

#bbcode-html-preview a {
    transition: opacity 0.2s;
}

#bbcode-html-preview a:hover {
    opacity: 0.8;
}

/* Alerts */
.alert {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

.alert-success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.alert-warning {
    background: rgba(251, 146, 60, 0.1);
    color: #fb923c;
}

/* Template Selector */
.template-select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 0.375rem 0.75rem;
    color: var(--text-primary);
    font-size: 0.75rem;
    cursor: pointer;
    min-width: 150px;
    transition: border-color 0.2s;
}

.template-select:hover,
.template-select:focus {
    border-color: var(--accent-color);
    outline: none;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.btn:hover {
    border-color: var(--accent-color);
}

.btn-primary {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-hover);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}

/* Loading animation */
.step-button.loading .step-icon svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Tracker release names */
.tracker-names-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
}

.tracker-name-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-tertiary, #1e293b);
    border-radius: 0.375rem;
    border-left: 3px solid var(--accent-primary, #3b82f6);
}

.tracker-slug {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--accent-primary, #3b82f6);
    min-width: 60px;
}

.tracker-name {
    font-size: 0.85rem;
    color: var(--text-secondary, #94a3b8);
    word-break: break-all;
}
</style>

<script>
async function checkDuplicates(releaseId) {
    const container = document.getElementById('duplicate-results-container');
    container.innerHTML = '<div class="empty-state"><div class="loading loading-spinner loading-lg"></div><p>Checking...</p></div>';

    try {
        const response = await fetch(`/api/releases/${releaseId}/check-duplicates`, { method: 'POST' });
        const result = await response.json();
        if (result.status === 'success') {
            window.location.reload();
        } else {
            container.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

async function executeStep(releaseId, stepName) {
    const resultDiv = document.getElementById('action-result');
    const button = event.currentTarget;

    button.classList.add('loading');
    resultDiv.innerHTML = '';

    try {
        const response = await fetch(`/api/releases/${releaseId}/step/${stepName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();

        if (result.status === 'success') {
            resultDiv.innerHTML = `<div class="alert alert-success"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${result.message}</div>`;
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">${result.message || 'Failed'}</div>`;
            button.classList.remove('loading');
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        button.classList.remove('loading');
    }
}

async function sendToQBittorrent(releaseId, trackerSlug) {
    const button = event.currentTarget;
    const resultDiv = document.getElementById('action-result');
    const originalText = button.textContent;

    button.classList.add('loading');
    button.textContent = '...';

    try {
        const response = await fetch(`/api/releases/${releaseId}/send-to-qbittorrent/${trackerSlug}`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.status === 'success') {
            button.textContent = '';
            button.style.background = 'rgba(34, 197, 94, 0.2)';
            button.style.color = '#22c55e';
            button.style.borderColor = '#22c55e';
            resultDiv.innerHTML = `<div class="alert alert-success"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${result.message}</div>`;
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('loading');
                button.style.background = '';
                button.style.color = '';
                button.style.borderColor = '';
            }, 3000);
        } else {
            button.textContent = originalText;
            button.classList.remove('loading');
            resultDiv.innerHTML = `<div class="alert alert-error">${result.message || 'Failed to send to qBittorrent'}</div>`;
        }
    } catch (error) {
        button.textContent = originalText;
        button.classList.remove('loading');
        resultDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

// BBCode to HTML converter
function bbcodeToHtml(bbcode) {
    let html = bbcode;

    // [center]...[/center]
    html = html.replace(/\[center\]([\s\S]*?)\[\/center\]/gi, '<div style="text-align: center;">$1</div>');

    // [img]url[/img]
    html = html.replace(/\[img\](.*?)\[\/img\]/gi, '<img src="$1" style="max-width: 100%; height: auto;" />');

    // [h1]...[/h1], [h2]...[/h2], [h3]...[/h3]
    html = html.replace(/\[h1\]([\s\S]*?)\[\/h1\]/gi, '<h1 style="font-size:1.8em;margin:0.5em 0;">$1</h1>');
    html = html.replace(/\[h2\]([\s\S]*?)\[\/h2\]/gi, '<h2 style="font-size:1.4em;margin:0.5em 0;">$1</h2>');
    html = html.replace(/\[h3\]([\s\S]*?)\[\/h3\]/gi, '<h3 style="font-size:1.2em;margin:0.4em 0;">$1</h3>');

    // [size=X]...[/size]
    html = html.replace(/\[size=(\d+)\]([\s\S]*?)\[\/size\]/gi, (m, size, text) => {
        const px = parseInt(size) * 4 + 8;
        return `<span style="font-size:${px}px;">${text}</span>`;
    });

    // [color=#XXX]...[/color]
    html = html.replace(/\[color=(#?[\w]+)\]([\s\S]*?)\[\/color\]/gi, '<span style="color: $1;">$2</span>');

    // [b]...[/b]
    html = html.replace(/\[b\]([\s\S]*?)\[\/b\]/gi, '<strong>$1</strong>');

    // [i]...[/i]
    html = html.replace(/\[i\]([\s\S]*?)\[\/i\]/gi, '<em>$1</em>');

    // [u]...[/u]
    html = html.replace(/\[u\]([\s\S]*?)\[\/u\]/gi, '<u>$1</u>');

    // [quote]...[/quote]
    html = html.replace(/\[quote\]([\s\S]*?)\[\/quote\]/gi, '<blockquote style="border-left: 3px solid #4a5568; padding-left: 1rem; margin: 1rem 0; color: #a0aec0;">$1</blockquote>');

    // [table], [tr], [td]
    html = html.replace(/\[table\]([\s\S]*?)\[\/table\]/gi, '<table style="border-collapse:collapse;margin:0.5em auto;width:auto;">$1</table>');
    html = html.replace(/\[tr\]([\s\S]*?)\[\/tr\]/gi, '<tr>$1</tr>');
    html = html.replace(/\[td\]([\s\S]*?)\[\/td\]/gi, '<td style="padding:4px 12px;border:1px solid #4a5568;">$1</td>');

    // [url]...[/url] or [url=...]...[/url]
    html = html.replace(/\[url=(.*?)\]([\s\S]*?)\[\/url\]/gi, '<a href="$1" style="color: #60a5fa; text-decoration: underline;">$2</a>');
    html = html.replace(/\[url\](.*?)\[\/url\]/gi, '<a href="$1" style="color: #60a5fa; text-decoration: underline;">$1</a>');

    // Convert newlines to <br>
    html = html.replace(/\n/g, '<br>');

    return html;
}

// Store current view mode
let bbcodeViewMode = 'bbcode'; // 'bbcode' or 'html'
let currentBBCodeContent = '';
let templatesLoaded = false;

// Load available templates on page load
async function loadTemplates() {
    if (templatesLoaded) return;

    try {
        const response = await fetch('/api/templates');
        const result = await response.json();

        if (result.status === 'success' && result.templates) {
            const selector = document.getElementById('template-selector');
            selector.innerHTML = '<option value="">Template par defaut</option>';

            result.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                if (template.is_default) {
                    option.textContent += ' (defaut)';
                }
                selector.appendChild(option);
            });

            templatesLoaded = true;
        }
    } catch (error) {
        console.error('Failed to load templates:', error);
    }
}

// Load templates when the page loads
document.addEventListener('DOMContentLoaded', loadTemplates);

async function loadBBCode(releaseId) {
    const container = document.getElementById('bbcode-container');
    const copyBtn = document.getElementById('copy-bbcode-btn');
    const toggleBtn = document.getElementById('toggle-view-btn');
    const templateSelector = document.getElementById('template-selector');
    const selectedTemplateId = templateSelector ? templateSelector.value : '';

    container.innerHTML = '<div class="empty-state small"><div class="loading loading-spinner"></div><p>Generating...</p></div>';
    copyBtn.style.display = 'none';
    toggleBtn.style.display = 'none';

    try {
        // Build URL with optional template_id parameter
        let url = `/api/releases/${releaseId}/bbcode`;
        if (selectedTemplateId) {
            url += `?template_id=${selectedTemplateId}`;
        }

        const response = await fetch(url);
        const result = await response.json();

        if (result.status === 'success' && result.bbcode) {
            currentBBCodeContent = result.bbcode;
            bbcodeViewMode = 'bbcode';

            const escaped = result.bbcode.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            container.innerHTML = `<textarea id="bbcode-content" readonly>${escaped}</textarea>`;
            copyBtn.style.display = 'flex';
            toggleBtn.style.display = 'flex';
        } else {
            container.innerHTML = `<div class="alert alert-warning">${result.message || 'Could not generate BBCode'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

function toggleBBCodeView() {
    const container = document.getElementById('bbcode-container');
    const toggleBtn = document.getElementById('toggle-view-btn');

    if (!currentBBCodeContent) return;

    if (bbcodeViewMode === 'bbcode') {
        // Switch to HTML view
        bbcodeViewMode = 'html';
        const html = bbcodeToHtml(currentBBCodeContent);
        container.innerHTML = `<div id="bbcode-html-preview" style="padding: 1rem; background: #1a202c; border-radius: 0.5rem; overflow-x: auto; font-family: 'Segoe UI', sans-serif; line-height: 1.6;">${html}</div>`;
        toggleBtn.title = 'Show BBCode';
    } else {
        // Switch to BBCode view
        bbcodeViewMode = 'bbcode';
        const escaped = currentBBCodeContent.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        container.innerHTML = `<textarea id="bbcode-content" readonly>${escaped}</textarea>`;
        toggleBtn.title = 'Show HTML Preview';
    }
}

async function copyBBCode() {
    const textarea = document.getElementById('bbcode-content');
    const copyBtn = document.getElementById('copy-bbcode-btn');
    if (!textarea) return;

    try {
        await navigator.clipboard.writeText(textarea.value);
        copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
        setTimeout(() => {
            copyBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
        }, 2000);
    } catch (e) {
        textarea.select();
        document.execCommand('copy');
    }
}
</script>
{% endblock %}
